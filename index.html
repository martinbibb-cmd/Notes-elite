<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Notes Elite — Drill-down Tiles</title>
<meta name="theme-color" content="#0b1016"/>
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg">
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg">
<style>
:root{--bg:#0b1016;--panel:#0f1720;--ink:#e8f0f6;--muted:#cbd6e1;--line:#142533;--tile:#0b141f;--tile2:#0d1a26;--tileEdge:#20405a;--tileActive:#0f2218;--brand:#7cc4ff;--ok:#2ecc71;--warn:#ffc857;--err:#ff6a6a}
*{box-sizing:border-box}
html,body{height:100%}html{color-scheme:dark}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
.app{height:100dvh;display:grid;grid-template-rows:64px auto 1fr 64px;background:
 url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right -40px top -40px/220px no-repeat,
 url("https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg") left -40px bottom -40px/220px no-repeat,
 linear-gradient(180deg,#0b1016,#0b1016 60%,#0a0f15)}
.header{display:flex;gap:12px;align-items:center;padding:0 14px;background:#0c151f;border-bottom:1px solid var(--line)}
.brand{display:flex;gap:10px;align-items:center;font-weight:700}.dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 10px var(--brand)}
.toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#0e1722;border-bottom:1px solid var(--line);flex-wrap:wrap}
.input{background:#0a121c;color:var(--ink);border:1px solid #1a2b3d;border-radius:10px;padding:8px 10px;min-width:240px}
.btn{appearance:none;border:1px solid #21405a;background:#112233;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.primary{border-color:#1f4d83;background:#113459}.btn.good{border-color:#1c5f3a;background:#0f2a1c}.btn.warn{border-color:#735a1a;background:#2b2410}
.status{font-size:12px}.ok{color:var(--ok)}.bad{color:var(--err)}.muted{opacity:.8}
.stage{display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--line);background:#0e1722}
.crumb{font-size:13px}.crumb a{color:var(--ink);text-decoration:none;border-bottom:1px dotted #355}
.spacer{flex:1}
.content{overflow:auto}
.grid{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.tile{background:linear-gradient(180deg,var(--tile),var(--tile2));border:1px solid var(--tileEdge);border-radius:14px;min-height:120px;padding:14px;cursor:pointer;display:flex;flex-direction:column;gap:8px}
.tile.big{min-height:140px}
.tile.active{border-color:var(--ok);background:var(--tileActive)}
.tile .img{height:36px;background:url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right/contain no-repeat;opacity:.9}
.t{font-weight:700}
.badges{display:flex;gap:6px;flex-wrap:wrap;font-size:11px;opacity:.9}
.badge{border:1px solid #23445f;border-radius:8px;padding:2px 6px}
.noteBox{padding:12px}
textarea{width:100%;resize:vertical;min-height:84px;background:#0a121c;color:var(--ink);border:1px solid #1a2b3d;border-radius:10px;padding:10px 12px}
.footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:#0c151f;border-top:1px solid var(--line)}
.copybox{white-space:pre-wrap;background:#0a121c;border:1px solid #1a2b3d;border-radius:10px;padding:10px;max-height:32dvh;overflow:auto;margin:12px}
.hidden{display:none}
.w3wBtn{margin-left:8px}
</style>
</head>
<body>
<div class="app">
  <div class="header"><div class="brand"><span class="dot"></span><span>Notes&nbsp;Elite</span></div><div id="hdr" class="muted"></div></div>

  <div class="toolbar">
    <span id="status" class="status">Ready</span>
    <input id="url" class="input" placeholder="Options.txt URL (defaults to jsDelivr)"/>
    <button class="btn" id="btnFetch">Fetch</button>
    <input type="file" id="file" accept=".txt" class="input"/>
    <button class="btn" id="btnPaste">Paste…</button>
    <button class="btn primary" id="btnResetState">Reset selections</button>
  </div>

  <!-- Breadcrumb stage -->
  <div class="stage">
    <button class="btn" id="btnBack">← Back</button>
    <div class="crumb" id="crumb">Sections</div>
    <div class="spacer"></div>
    <button class="btn hidden" id="btnW3W">What3Words…</button>
  </div>

  <!-- Main content (tiles) -->
  <div class="content">
    <div id="grid" class="grid"></div>
    <div id="notesWrap" class="noteBox hidden">
      <textarea id="notes" placeholder="Free-text notes for this section/category…"></textarea>
      <div class="muted" style="margin-top:6px">Tip: Notes are saved per section; JSON merges picks + notes.</div>
      <div id="jsonPreview" class="copybox hidden"></div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <button class="btn" id="btnHome">Sections</button>
    <button class="btn" id="btnBuild">Build JSON</button>
    <button class="btn primary" id="btnCopy">Copy JSON</button>
    <button class="btn good" id="btnDownload">Download JSON</button>
  </div>
</div>

<!-- Minimal W3W modal -->
<div id="w3wModal" class="hidden">
  <div class="copybox">
    <div><b>What3Words</b></div>
    <input id="w3wInput" class="input" placeholder="filled.count.soap  or  50.7341,-1.7763" style="width:100%;margin:8px 0"/>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="w3wValidate">Validate</button>
      <button class="btn" id="w3wGPS">Use GPS</button>
      <button class="btn primary" id="w3wSave">Save</button>
      <button class="btn warn" id="w3wClose">Close</button>
      <span id="w3wStatus" class="status">Idle</span>
    </div>
  </div>
</div>

<script>
/* ---------- constants ---------- */
const DEFAULT_URL="https://cdn.jsdelivr.net/gh/martinbibb-cmd/Depot-notes@main/Options.txt";
const RAW_URL="https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/main/Options.txt";
const GH_HTML="https://github.com/martinbibb-cmd/Depot-notes/blob/main/Options.txt";

const UI_SECTIONS=["Needs","Working at heights","System characteristics","Arse_cover_notes","Components that require assistance","Restrictions to work","External hazards","Delivery notes","Office notes","New boiler and controls","Flue","Pipe work","Disruption","Gas","Condensate","Boiler","Flush","Filter","Controls","Cylinder","Radiators","Customer actions"];

const SINGLE=new Set(["Flue","Gas","Condensate","Boiler","Flush","Filter","Cylinder"]);
const W3W_SECTION="Delivery notes";

/* ---------- state ---------- */
const $=s=>document.querySelector(s); const grid=$("#grid");
const state=Object.assign({parsed:{},w3w:null,selections:{},notes:{}},load());
function save(){localStorage.setItem("notes-elite-drill",JSON.stringify(state))}
function load(){try{return JSON.parse(localStorage.getItem("notes-elite-drill")||"{}")}catch{return{}}}
function norm(s){return (s||"").toLowerCase().replace(/[_-]/g," ").replace(/\s+/g," ").trim()}
function is3w(s){return /^[a-z]+\.([a-z]+)\.([a-z]+)$/i.test((s||"").trim().replace(/^\/+/,''))}
function isLL(s){return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test((s||"").trim())}

/* ---------- parse Options.txt (pipe format + |subgroup) ---------- */
function parsePipe(txt){
  const out={}; let cur=null, subgroup=null;
  txt.replace(/\r\n/g,"\n").split("\n").forEach(raw=>{
    const ln=raw.replace(/\s+$/,'');
    const m=ln.match(/^\s*\[(.+?)\]\s*$/);
    if(m){cur=m[1]; out[cur]=out[cur]||[]; subgroup=null; return}
    if(!cur || !ln.trim()) return;
    if(/^\s*\|[^|]/.test(ln)){subgroup=ln.replace(/^\s*\|/,'' ).trim(); return}
    const parts=ln.split("|").map(x=>x.trim()).filter(x=>x!==""||x==="0");
    if(parts.length>=2){
      const code=parts[0], category=parts.length>=3?parts[1]:"", text=parts.length>=3?parts.slice(2).join(" | "):parts[1];
      out[cur].push({code,category,text,subgroup});
    }else{
      out[cur].push({code:"",category:"",text:ln.trim(),subgroup});
    }
  });
  return out;
}

/* ---------- drill stack ---------- */
let stack=[{level:"root"}]; // root -> section -> group -> category -> items

function setStage(text){ $("#crumb").innerHTML=text; }
function push(node){ stack.push(node); render(); }
function back(){ if(stack.length>1){ stack.pop(); render(); } }
function toRoot(){ stack=[{level:"root"}]; render(); }

/* ---------- selections helpers ---------- */
function togglePick(section, key, single){
  state.selections[section]=state.selections[section]||{};
  if(single){ state.selections[section]={}; state.selections[section][key]=true; }
  else{ state.selections[section][key]=!state.selections[section][key]; }
  save();
}
function isPicked(section, key){ return !!(state.selections?.[section]?.[key]); }

/* ---------- render ---------- */
function render(){
  $("#status").textContent="Ready";
  $("#btnBack").disabled = (stack.length===1);
  $("#btnW3W").classList.toggle("hidden", !(stack[1]?.section===W3W_SECTION && stack.at(-1).level==="items"));

  // notes box shows when at items level
  const atItems = stack.at(-1).level==="items";
  $("#notesWrap").classList.toggle("hidden", !atItems);

  const stageText = stack.map(n=>{
    if(n.level==="root") return "Sections";
    if(n.level==="section") return n.section;
    if(n.level==="group") return n.group;
    if(n.level==="category") return n.category;
    if(n.level==="items") return "Items";
  }).filter(Boolean).join(" › ");
  setStage(stageText);

  grid.innerHTML="";
  const top = stack.at(-1);

  if(top.level==="root"){
    $("#hdr").textContent="Tap a section to begin";
    UI_SECTIONS.forEach(sec=>{
      const secItems = (state.parsed[sec]||[]);
      const t=document.createElement("div"); t.className="tile big";
      t.innerHTML=`<div class="img"></div><div class="t">${sec}</div><div class="muted">${secItems.length} options</div>`;
      t.onclick=()=>push({level:"section", section:sec});
      grid.appendChild(t);
    });
    $("#notesWrap").classList.add("hidden");
    return;
  }

  if(top.level==="section"){
    const sec=top.section; const items = state.parsed[sec]||[];
    $("#hdr").textContent = `${sec} • ${items.length} options`;

    // derive groups (subgroup field) — if none, derive from Category
    const groups = Array.from(new Set(items.map(x=>x.subgroup).filter(Boolean)));
    if(groups.length){
      groups.forEach(g=>{
        const count=items.filter(x=>x.subgroup===g).length;
        const t=document.createElement("div"); t.className="tile big";
        t.innerHTML=`<div class="img"></div><div class="t">${g}</div><div class="muted">${count} options</div>`;
        t.onclick=()=>push({level:"group", section:sec, group:g});
        grid.appendChild(t);
      });
    }else{
      const cats = Array.from(new Set(items.map(x=>x.category).filter(Boolean)));
      if(cats.length){
        cats.forEach(c=>{
          const count=items.filter(x=>x.category===c).length;
          const t=document.createElement("div"); t.className="tile big";
          t.innerHTML=`<div class="img"></div><div class="t">${c}</div><div class="muted">${count} options</div>`;
          t.onclick=()=>push({level:"category", section:sec, category:c});
          grid.appendChild(t);
        });
      }else{
        // no groups or categories: go straight to items
        push({level:"items", section:sec, items});
      }
    }
    $("#notesWrap").classList.add("hidden");
    return;
  }

  if(top.level==="group"){
    const sec=top.section;
    const items=(state.parsed[sec]||[]).filter(x=>x.subgroup===top.group);
    // Next: categories inside this group (if present), otherwise items
    const cats = Array.from(new Set(items.map(x=>x.category).filter(Boolean)));
    if(cats.length){
      cats.forEach(c=>{
        const count=items.filter(x=>x.category===c).length;
        const t=document.createElement("div"); t.className="tile big";
        t.innerHTML=`<div class="img"></div><div class="t">${c}</div><div class="muted">${count} options</div>`;
        t.onclick=()=>push({level:"category", section:sec, group:top.group, category:c});
        grid.appendChild(t);
      });
      $("#notesWrap").classList.add("hidden");
      return;
    }else{
      push({level:"items", section:sec, group:top.group, items});
    }
  }

  if(top.level==="category"){
    const sec=top.section;
    const items=(state.parsed[sec]||[]).filter(x=>{
      if(top.group && x.subgroup!==top.group) return false;
      return (x.category===top.category);
    });
    push({level:"items", section:sec, group:top.group, category:top.category, items});
    return;
  }

  if(top.level==="items"){
    const sec=top.section; const single=SINGLE.has(sec);
    const items = top.items || (state.parsed[sec]||[]).filter(x=>{
      if(top.group && x.subgroup!==top.group) return false;
      if(top.category && x.category!==top.category) return false;
      return true;
    });

    items.forEach(rec=>{
      const key=`${rec.code}|${rec.text}`;
      const t=document.createElement("div"); t.className="tile";
      if(isPicked(sec,key)) t.classList.add("active");
      t.innerHTML=`<div class="img"></div>
        <div class="t">${rec.text||rec.category||rec.code}</div>
        <div class="badges">
          ${rec.code?`<span class="badge">${rec.code}</span>`:""}
          ${rec.category?`<span class="badge">${rec.category}</span>`:""}
          ${rec.subgroup?`<span class="badge">${rec.subgroup}</span>`:""}
          ${single?`<span class="badge">single</span>`:"<span class="badge">multi</span>`}
        </div>`;
      t.onclick=()=>{togglePick(sec,key,single); t.classList.toggle("active",isPicked(sec,key));};
      grid.appendChild(t);
    });

    // notes area for this section
    $("#notesWrap").classList.remove("hidden");
    const noteKey = [sec, top.group, top.category].filter(Boolean).join(" / ");
    $("#notes").value = state.notes[noteKey] || "";
    $("#notes").oninput = e=>{ state.notes[noteKey]=e.target.value; save(); };

    return;
  }
}

/* ---------- JSON ---------- */
function buildJSON(){
  const out={meta:{generatedAt:new Date().toISOString(),sourceURL:$("#url").value||DEFAULT_URL,what3words:state.w3w||null},sections:{}};
  UI_SECTIONS.forEach(sec=>{
    const picks = Object.keys(state.selections[sec]||{}).filter(k=>state.selections[sec][k]).map(k=>{
      const i=k.indexOf("|"); return {code:i>-1?k.slice(0,i):"", text:i>-1?k.slice(i+1):k}
    });
    const noteParts=[];
    // merge any note keys that start with this section (section / group / category)
    Object.entries(state.notes).forEach(([k,v])=>{ if(k.startsWith(sec) && v.trim()) noteParts.push(v.trim()); });
    const text=[picks.length?("• "+picks.map(p=>(p.code?`${p.code} – `:"")+p.text).join("; ")): "", noteParts.join(" ")].filter(Boolean).join(" ");
    out.sections[sec]={text,picks};
  });
  return out;
}

/* ---------- file/paste/fetch ---------- */
async function fetchWithFallback(urls){
  for(const u of urls){
    try{
      $("#status").textContent=`Fetching from ${new URL(u).hostname}…`;
      const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const ct=r.headers.get("content-type")||""; let txt=await r.text();
      if(!/text\/|octet-stream/i.test(ct) && /<html/i.test(txt)){
        const m=txt.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i) || txt.match(/<tbody[^>]*>([\s\S]*?)<\/tbody>/i);
        if(m) txt=m[1].replace(/<[^>]+>/g,'').replace(/&nbsp;/g,' ').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
      }
      $("#status").textContent=`Loaded from ${new URL(u).hostname}`; $("#status").className="status ok";
      return txt;
    }catch(e){ $("#status").textContent=`Failed ${u} (${e.message})`; $("#status").className="status bad"; }
  }
  throw new Error("All sources failed");
}
function applyOptionsText(txt){
  state.parsed=parsePipe(txt); save();
  // ensure every requested UI section exists even if empty
  UI_SECTIONS.forEach(s=>{ state.parsed[s]=state.parsed[s]||[]; });
  toRoot();
}

/* ---------- W3W ---------- */
$("#btnW3W").onclick=()=>{ $("#w3wModal").classList.remove("hidden"); };
$("#w3wClose").onclick=()=>{ $("#w3wModal").classList.add("hidden"); };
$("#w3wGPS").onclick=()=>navigator.geolocation?.getCurrentPosition(
  pos=>{$("#w3wInput").value=`${pos.coords.latitude},${pos.coords.longitude}`; $("#w3wStatus").textContent="GPS captured"},
  ()=>$("#w3wStatus").textContent="GPS unavailable"
);
$("#w3wValidate").onclick=()=>{const v=$("#w3wInput").value||""; $("#w3wStatus").textContent=is3w(v)?"✓ three words":(isLL(v)?"✓ lat,long":"Unrecognised (stored raw)")};
$("#w3wSave").onclick=()=>{const s=($("#w3wInput").value||"").trim().replace(/^\/+/, ''); if(!s){$("#w3wStatus").textContent="Nothing entered";return}
  if(is3w(s)) state.w3w={words:s.toLowerCase()}; else if(isLL(s)){const [lat,lng]=s.split(',').map(x=>+x.trim()); state.w3w={coords:{lat,lng}};} else state.w3w={raw:s};
  save(); $("#w3wModal").classList.add("hidden");
};

/* ---------- controls ---------- */
$("#btnBack").onclick=back;
$("#btnHome").onclick=toRoot;
$("#btnBuild").onclick=()=>{const j=JSON.stringify(buildJSON(),null,2); $("#jsonPreview").classList.remove("hidden"); $("#jsonPreview").textContent=j;};
$("#btnCopy").onclick=()=>navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2));
$("#btnDownload").onclick=()=>{const blob=new Blob([JSON.stringify(buildJSON(),null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`depot-notes_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click();};
$("#btnResetState").onclick=()=>{localStorage.removeItem("notes-elite-drill"); location.reload();};

$("#btnFetch").onclick=async()=>{try{const txt=await fetchWithFallback([$("#url").value||DEFAULT_URL, RAW_URL, GH_HTML]); applyOptionsText(txt);}catch(e){$("#status").textContent=e.message; $("#status").className="status bad";}};
$("#file").onchange=async e=>{const f=e.target.files[0]; if(!f) return; const txt=await f.text(); $("#status").textContent=`Loaded ${f.name}`; $("#status").className="status ok"; applyOptionsText(txt);};
$("#btnPaste").onclick=()=>{const t=prompt("Paste Options.txt content:"); if(t){$("#status").textContent="Loaded from paste"; $("#status").className="status ok"; applyOptionsText(t);}};

/* ---------- boot ---------- */
(function boot(){
  $("#url").value = $("#url").value || DEFAULT_URL;
  // If we already have parsed data from a previous run, render immediately; otherwise fetch
  if(state.parsed && Object.keys(state.parsed).length){ toRoot(); }
  else { fetchWithFallback([DEFAULT_URL, RAW_URL, GH_HTML]).then(applyOptionsText).catch(()=>toRoot()); }
})();

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(err=>console.warn('SW registration failed',err));
  });
}
</script>
</body>
</html>
