<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Notes Elite — Options.txt Powered (Robust Loader)</title>
<meta name="theme-color" content="#0b1016"/>

<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg">
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg">

<style>
:root{
  --bg:#0b1016; --panel:#0f1720; --ink:#e8f0f6; --muted:#cbd6e1; --line:#142533;
  --tile:#0b141f; --tile2:#0d1a26; --tileEdge:#20405a; --tileActive:#0f2218;
  --brand:#7cc4ff; --ok:#2ecc71; --warn:#ffc857; --err:#ff6a6a;
}
*{box-sizing:border-box}
html,body{height:100%}
html{color-scheme:dark}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}

.app{
  height:100dvh; display:grid; grid-template-rows:64px 1fr 56px;
  background:
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right -40px top -40px/220px no-repeat,
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg") left -40px bottom -40px/220px no-repeat,
    linear-gradient(180deg,#0b1016,#0b1016 60%,#0a0f15);
}
.header{display:flex;align-items:center;gap:12px;padding:0 14px;background:#0c151f;border-bottom:1px solid var(--line)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 10px var(--brand)}
.hint{margin-left:auto;font-size:12px;opacity:.85}

.sourceBar{display:flex;gap:8px;align-items:center; padding:6px 10px; background:#0e1722; border-bottom:1px solid var(--line)}
.sourceBar input{flex:1; min-width:200px; background:#0a121c; color:var(--ink); border:1px solid #1a2b3d; border-radius:10px; padding:8px 10px}
.sourceBar .status{font-size:12px;opacity:.9}
.sourceBar .status.bad{color:var(--err)}
.sourceBar .status.ok{color:var(--ok)}
.btnSm{appearance:none;border:1px solid #21405a;background:#112233;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}

.content{
  display:grid; grid-template-columns: 260px 1fr; gap:10px;
  padding:10px; overflow:hidden;
}
@media (max-width: 900px){ .content{ grid-template-columns: 1fr; } }

.sidebar{
  background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:100%;
}
.sidebar h3{margin:10px 12px;font-size:13px;opacity:.9}
.nav{list-style:none;margin:0;padding:6px}
.nav button{
  width:100%; text-align:left; display:block; border:0; background:transparent; color:var(--ink);
  padding:10px 12px; border-radius:10px; cursor:pointer;
}
.nav button.active{background:#0e1a28; border:1px solid #1d3a54}
.nav button:hover{background:#0d1620}

.main{
  background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:100%;
  display:flex; flex-direction:column;
}
.sectionHead{position:sticky;top:0;background:#0f1720;border-bottom:1px solid var(--line);padding:10px 12px;z-index:1}
.sectionBody{padding:10px 12px; display:grid; gap:10px}

.tiles{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px}
.tile{
  background:linear-gradient(180deg,var(--tile),var(--tile2));
  border:1px solid var(--tileEdge); border-radius:14px; padding:12px; cursor:pointer;
  min-height:72px; display:flex; flex-direction:column; gap:6px; transition:transform .06s ease,border-color .1s ease,background .1s ease;
}
.tile:hover{transform:translateY(-1px)}
.tile.active{border-color:var(--ok); background:var(--tileActive)}
.tile .img{height:28px;background:url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right/contain no-repeat;opacity:.9}
.tile .t{font-weight:700}
.small{font-size:12px;opacity:.85}

.input, textarea{
  width:100%; background:#0a121c; color:var(--ink); border:1px solid #1a2b3d; border-radius:10px; padding:10px 12px; outline:none
}
textarea{resize:vertical;min-height:84px}

.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{font-size:12px;opacity:.85}

.footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:#0c151f;border-top:1px solid var(--line)}
.btn{appearance:none;border:1px solid #21405a;background:#112233;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.primary{border-color:#1f4d83;background:#113459}
.btn.good{border-color:#1c5f3a;background:#0f2a1c}
.btn.warn{border-color:#735a1a;background:#2b2410}
.btn:active{transform:translateY(1px)}

.copybox{white-space:pre-wrap;background:#0a121c;border:1px solid #1a2b3d;border-radius:10px;padding:10px;max-height:32dvh;overflow:auto}

.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
.modal{width:min(720px,96vw);background:#0e1722;border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.show{display:flex!important}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand"><span class="dot"></span><span>Notes&nbsp;Elite</span></div>
    <div class="hint">Tiles load from <code>Options.txt</code> • Build JSON below.</div>
  </div>

  <!-- Source / status bar -->
  <div class="sourceBar">
    <span class="small">Options URL:</span>
    <input id="optionsUrl" />
    <button class="btnSm" id="reloadBtn">Reload</button>
    <span id="sourceStatus" class="status">loading…</span>
  </div>

  <div class="content">
    <aside class="sidebar">
      <h3>Sections</h3>
      <ul class="nav" id="nav"></ul>
    </aside>

    <main class="main" id="main"></main>
  </div>

  <div class="footer">
    <button class="btn" id="btnBuild">Build JSON</button>
    <button class="btn primary" id="btnCopy">Copy JSON</button>
    <button class="btn good" id="btnDownload">Download JSON</button>
    <button class="btn warn" id="btnReset">Reset</button>
  </div>
</div>

<!-- What3Words (manual; no API) -->
<div class="modalBack" id="w3wModal">
  <div class="modal">
    <strong>What3Words (manual)</strong>
    <input class="input" id="w3wInput" placeholder="filled.count.soap  or  50.7341,-1.7763"/>
    <div class="row">
      <button class="btn" id="w3wValidate">Validate format</button>
      <button class="btn" id="w3wGPS">Use device GPS</button>
      <span class="badge" id="w3wStatus">Idle</span>
    </div>
    <div class="row">
      <button class="btn primary" id="w3wSave">Save</button>
      <button class="btn" id="w3wClose">Close</button>
    </div>
    <span class="small">We store what you enter — no network calls.</span>
  </div>
</div>

<script>
/* =========================
   Robust Options loader
   ========================= */
/* Preferred sources (try in order) — update your user/repo if needed */
const RAW_URL   = "https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/main/Options.txt";
const JSD_URL   = "https://cdn.jsdelivr.net/gh/martinbibb-cmd/Depot-notes@main/Options.txt";
const GH_HTML   = "https://github.com/martinbibb-cmd/Depot-notes/blob/main/Options.txt"; // HTML fallback

/* Canonical UI order (per your list) */
const UI_SECTIONS = [
  "Needs","Working at heights","System characteristics","Arse_cover_notes",
  "Components that require assistance","Restrictions to work","External hazards",
  "Delivery notes","Office notes","New boiler and controls","Flue","Pipe work",
  "Disruption","Gas","Condensate","Boiler","Flush","Filter","Controls",
  "Cylinder","Radiators","Customer actions","Summary"
];

const SINGLE_SELECT = new Set(["Flue","Gas","Condensate","Boiler","Flush","Filter","Cylinder"]);
const W3W_IN_SECTION = "Delivery notes";

/* = State = */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const state = Object.assign({ selections:{}, notes:{}, custom:{}, w3w:null, parsed:{}, sectionMap:{} }, load());
function save(){ localStorage.setItem('notes-elite-optxt-robust', JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem('notes-elite-optxt-robust')||'{}'); }catch{ return {}; } }
function listOf(group){ return group ? Object.keys(group).filter(k=>group[k]) : []; }
function norm(s){ return (s||"").toLowerCase().replace(/\s+/g,' ').replace(/[_-]/g,' ').trim(); }
function isThreeWords(s){ return /^[a-z]+\.([a-z]+)\.([a-z]+)$/i.test(s.trim().replace(/^\/+/,'')); }
function isLatLng(s){ return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test(s.trim()); }

/* ===== fetching with fallbacks (handles CORS) ===== */
async function fetchText(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  // If html, try to extract <pre> content (GitHub blob view)
  const ct = r.headers.get('content-type')||'';
  const text = await r.text();
  if (!/text\/plain|text\/.*|application\/octet-stream/i.test(ct) && /<html/i.test(text)){
    const pre = text.match(/<table[^>]*class="highlight[^"]*"[\s\S]*?<tbody>([\s\S]*?)<\/tbody>/i) || text.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
    if(pre){ return pre[1].replace(/<[^>]+>/g,'').replace(/&nbsp;/g,' ').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&'); }
  }
  return text;
}
async function loadOptions(urls){
  const status = $('#sourceStatus');
  for (const u of urls){
    try{
      status.textContent = `loading from ${new URL(u).hostname}…`;
      const t = await fetchText(u);
      // sanity check: must contain [Section] style
      if(!/\[[^\]]+\]/.test(t)) throw new Error('No [Section] headers detected');
      status.textContent = `loaded from ${new URL(u).hostname}`;
      status.className = "status ok";
      return {text:t, source:u};
    }catch(e){
      status.textContent = `failed on ${new URL(u).hostname}: ${e.message}`;
      status.className = "status bad";
    }
  }
  throw new Error("All sources failed");
}

/* ===== parse [Section] blocks into { sec:[lines] } ===== */
function parseOptions(txt){
  const lines = txt.replace(/\r\n/g,'\n').split('\n');
  const out = {}; let cur = null;
  for(const raw of lines){
    const m = raw.match(/^\s*\[(.+?)\]\s*$/);
    if(m){ cur = m[1]; out[cur] = out[cur] || []; continue; }
    if(!cur) continue;
    const line = raw.replace(/\s+$/,'');
    if(!line) continue;
    if(line.trim().startsWith('- ')) out[cur].push(line.trim().slice(2));
    else out[cur].push(line.trim());
  }
  return out;
}

/* ===== map parsed -> UI names (fuzzy) ===== */
function buildSectionMap(parsed){
  const byNorm = {};
  Object.entries(parsed).forEach(([k,v])=> byNorm[norm(k)] = v);

  const map = {};
  UI_SECTIONS.forEach(ui=>{
    if(ui==="Summary"){ map[ui]=[]; return; }
    let tiles = byNorm[norm(ui)];

    if(!tiles){
      const aliases = {
        "working at heights": ["working at height","wah","access & wah","access and wah","working at heights (wah)"],
        "arse_cover_notes": ["arse cover notes","arse-cover-notes","cover notes","cover_notes"],
        "system characteristics": ["system chars","system characteristics (a pack)","system"],
        "components that require assistance": ["components require assistance","assistance components"],
        "restrictions to work": ["restrictions","work restrictions"],
        "external hazards": ["hazards","external hazards & risks","hazards external"],
        "delivery notes": ["delivery","parking","delivery & parking","delivery and parking"],
        "office notes": ["office","admin notes","office/admin notes"],
        "new boiler and controls": ["new boiler","new boiler & controls","boiler and controls","new boiler controls"],
        "pipe work": ["pipework","pipe-work","pipe work notes","pipes"],
        "customer actions": ["customer to","customer actions required","customer jobs","actions for customer"]
      }[norm(ui)];
      if(aliases){ for(const a of aliases){ if(byNorm[a]){ tiles = byNorm[a]; break; } }
    }
    map[ui] = Array.isArray(tiles) ? tiles.filter(Boolean) : [];
  });
  return map;
}

/* ===== UI build ===== */
const nav = $('#nav');
const main = $('#main');

function buildUI(){
  nav.innerHTML = ''; main.innerHTML = '';

  UI_SECTIONS.forEach((sec, i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<button data-target="${sec}" ${i===0?'class="active"':''}>${sec}</button>`;
    nav.appendChild(li);

    const panel = document.createElement('section');
    panel.className = 'panel'; panel.dataset.section = sec; panel.style.display = (i===0?'block':'none');

    const tiles = (sec==="Summary") ? [] : (state.sectionMap?.[sec] || []);
    const isSingle = SINGLE_SELECT.has(sec);
    const w3wCtl = (sec===W3W_IN_SECTION);

    panel.innerHTML = `
      <div class="sectionHead">
        <strong>${sec}</strong>
        ${tiles.length?`<span class="small"> • ${tiles.length} options</span>`:`<span class="small" style="color:var(--warn)"> • no options found</span>`}
      </div>
      <div class="sectionBody">
        ${tiles.length?`<div class="tiles" data-tiles></div>`:`<div class="small">Add items under [${sec}] in Options.txt to see tiles here (still usable with notes).</div>`}
        ${w3wCtl?`
          <div class="row"><button class="btn" id="openW3W">What3Words…</button>
          <span class="badge">Saved: <strong id="w3wView">—</strong></span></div>`:''}
        ${sec!=="Summary"?`
          <textarea class="input" placeholder="Free-text notes for '${sec}'…" data-notes></textarea>
          <div class="row">
            <input class="input" placeholder="Add custom line…" data-custom-input />
            <button class="btn" data-custom-add>Add</button>
          </div>
          <div class="small" data-custom-list></div>
        `:`
          <div class="row">
            <button class="btn" id="buildNow">Build JSON</button>
            <button class="btn primary" id="copyNow">Copy JSON</button>
            <button class="btn good" id="downloadNow">Download JSON</button>
          </div>
          <div id="jsonPreview" class="copybox" aria-live="polite">No JSON yet.</div>
        `}
      </div>`;
    main.appendChild(panel);

    if(tiles.length){
      const wrap = panel.querySelector('[data-tiles]');
      tiles.forEach(label=>{
        const div = document.createElement('div');
        div.className='tile';
        div.innerHTML = `<div class="img"></div><div class="t">${label}</div>`;
        div.dataset.value = label; div.dataset.mode = isSingle?'single':'multi';
        wrap.appendChild(div);
      });
    }
  });

  wirePanels();
}

function wirePanels(){
  const panels = $$('.panel');
  $('#nav').addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-target]'); if(!b) return;
    panels.forEach(p=>p.style.display = (p.dataset.section===b.dataset.target)?'block':'none');
    $$('#nav button').forEach(bb=>bb.classList.toggle('active', bb===b));
    $('#main').scrollTop = 0;
  });

  panels.forEach(panel=>{
    const section = panel.dataset.section;

    panel.querySelectorAll('.tile').forEach(tile=>{
      if (state.selections?.[section]?.[tile.dataset.value]) tile.classList.add('active');
      tile.addEventListener('click', ()=>{
        const mode = tile.dataset.mode, val = tile.dataset.value;
        state.selections[section] = state.selections[section] || {};
        if(mode==='single'){
          [...tile.parentElement.children].forEach(sib=>{
            sib.classList.remove('active');
            if (sib!==tile && state.selections[section]) delete state.selections[section][sib.dataset.value];
          });
          state.selections[section][val] = true;
          tile.classList.add('active');
        }else{
          state.selections[section][val] = !state.selections[section][val];
          tile.classList.toggle('active', !!state.selections[section][val]);
        }
        save();
      });
    });

    const ta = panel.querySelector('[data-notes]');
    if (ta){
      ta.value = state.notes?.[section] || '';
      ta.addEventListener('input', e=>{ state.notes[section] = e.target.value; save(); });
    }

    const addBtn = panel.querySelector('[data-custom-add]');
    if (addBtn){
      const input = panel.querySelector('[data-custom-input]');
      const list = panel.querySelector('[data-custom-list]');
      function render(){ const arr = state.custom?.[section]||[]; list.innerHTML = arr.map((t,i)=>`<span class="badge">• ${t} <a href="#" data-del="${i}">×</a></span>`).join(' '); }
      render();
      addBtn.addEventListener('click', ()=>{
        const v=(input.value||'').trim(); if(!v) return;
        state.custom[section]=state.custom[section]||[]; state.custom[section].push(v); input.value=''; save(); render();
      });
      list.addEventListener('click', e=>{
        const idx=e.target.getAttribute('data-del'); if(idx===null) return; state.custom[section].splice(+idx,1); save(); render(); e.preventDefault();
      });
    }

    if (section===W3W_IN_SECTION){
      const btn = panel.querySelector('#openW3W');
      const view = panel.querySelector('#w3wView');
      btn?.addEventListener('click', ()=> $('#w3wModal').classList.add('show'));
      if(view) view.textContent = state.w3w?.words ? `///${state.w3w.words}` :
                       (state.w3w?.coords ? `${state.w3w.coords.lat},${state.w3w.coords.lng}` : (state.w3w?.raw||'—'));
    }

    if (section==='Summary'){
      panel.querySelector('#buildNow').addEventListener('click', ()=> $('#jsonPreview').textContent = JSON.stringify(buildJSON(),null,2));
      panel.querySelector('#copyNow').addEventListener('click', ()=> navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2)));
      panel.querySelector('#downloadNow').addEventListener('click', downloadJSON);
    }
  });
}

/* ===== What3Words modal (manual only) ===== */
$('#w3wClose').onclick = ()=> $('#w3wModal').classList.remove('show');
$('#w3wGPS').onclick = ()=> navigator.geolocation?.getCurrentPosition(
  pos => { $('#w3wInput').value = `${pos.coords.latitude},${pos.coords.longitude}`; $('#w3wStatus').textContent='GPS captured'; },
  ()=> $('#w3wStatus').textContent='GPS unavailable'
);
$('#w3wValidate').onclick = ()=>{
  const s = ($('#w3wInput').value||'').trim();
  if (isThreeWords(s)) return $('#w3wStatus').textContent = '✓ three words format';
  if (isLatLng(s))    return $('#w3wStatus').textContent = '✓ lat,long format';
  $('#w3wStatus').textContent = 'Not recognised (will store raw)';
};
$('#w3wSave').onclick = ()=>{
  const s = ($('#w3wInput').value||'').trim().replace(/^\/+,'');
  if (!s){ $('#w3wStatus').textContent='Nothing entered'; return; }
  if (isThreeWords(s)) state.w3w = {words:s.toLowerCase()};
  else if (isLatLng(s)){ const [lat,lng]=s.split(',').map(x=>+x.trim()); state.w3w = {coords:{lat,lng}}; }
  else state.w3w = {raw:s};
  save(); $('#w3wModal').classList.remove('show');
  const dv = document.querySelector('[data-section="Delivery notes"] #w3wView');
  if (dv) dv.textContent = state.w3w.words ? `///${state.w3w.words}` :
            (state.w3w.coords ? `${state.w3w.coords.lat},${state.w3w.coords.lng}` : (state.w3w.raw||'—'));
};

/* ===== JSON build & footer ===== */
function buildJSON(){
  const out = { meta:{
      generatedAt: new Date().toISOString(),
      what3words: state.w3w || null,
      optionsSource: $('#optionsUrl').value
    }, sections:{} };

  for (const name of UI_SECTIONS){
    if (name==='Summary') continue;
    const picks = listOf(state.selections[name]);
    const notes = state.notes?.[name] || '';
    const custom = state.custom?.[name] || [];
    const parts = [];
    if (picks.length) parts.push(picks.join('; '));
    if (custom.length) parts.push(custom.map(x=>`• ${x}`).join(' '));
    if (notes) parts.push(notes);
    out.sections[name] = parts.join(' ').trim();
  }
  return out;
}
function downloadJSON(){
  const data = buildJSON();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `depot-notes_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.click();
}
$('#btnBuild').onclick = ()=>{ const d=buildJSON(); const p=document.querySelector('[data-section="Summary"] #jsonPreview'); if(p){ p.textContent=JSON.stringify(d,null,2);} const btn=[...$$('#nav button')].find(b=>b.dataset.target==='Summary'); btn?.click(); };
$('#btnCopy').onclick = ()=> navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2));
$('#btnDownload').onclick = downloadJSON;
$('#btnReset').onclick = ()=>{ localStorage.removeItem('notes-elite-optxt-robust'); location.reload(); };

/* ===== Boot: try multiple sources; show status ===== */
async function boot(fromUrl){
  const urlInput = $('#optionsUrl');
  const status = $('#sourceStatus');
  const tryList = fromUrl ? [fromUrl] : [JSD_URL, RAW_URL, GH_HTML];
  urlInput.value = fromUrl || JSD_URL;

  try{
    const {text, source} = await loadOptions(tryList);
    state.parsed = parseOptions(text);
    state.sectionMap = buildSectionMap(state.parsed);
    save();
    const sectionsFound = Object.keys(state.parsed).length;
    status.textContent = `OK • ${sectionsFound} sections from ${new URL(source).hostname}`;
    status.className = "status ok";
  }catch(e){
    status.textContent = `Could not load Options.txt (${e.message}). Using notes only.`;
    status.className = "status bad";
    state.parsed = {}; state.sectionMap = {}; save();
  }
  buildUI();
}
$('#reloadBtn').onclick = ()=> boot($('#optionsUrl').value.trim());

boot(); // initial
</script>
</body>
</html>
