<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Notes Elite — Sections to JSON</title>
<meta name="theme-color" content="#0b1016"/>

<!-- Decorative images only (no CSS/JS pulled in) -->
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg">
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg">

<style>
:root{
  --bg:#0b1016; --panel:#0f1720; --ink:#e8f0f6; --muted:#cbd6e1; --line:#142533;
  --tile:#0b141f; --tile2:#0d1a26; --tileEdge:#20405a; --tileActive:#0f2218;
  --brand:#7cc4ff; --ok:#2ecc71;
}
*{box-sizing:border-box}
html,body{height:100%}
html{color-scheme:dark}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}

.app{
  height:100dvh; display:grid; grid-template-rows:56px 1fr 56px;
  background:
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right -40px top -40px/220px no-repeat,
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg") left -40px bottom -40px/220px no-repeat,
    linear-gradient(180deg,#0b1016,#0b1016 60%,#0a0f15);
}
.header{display:flex;align-items:center;gap:12px;padding:0 14px;background:#0c151f;border-bottom:1px solid var(--line)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 10px var(--brand)}
.hint{margin-left:auto;font-size:12px;opacity:.85}

.content{
  display:grid; grid-template-columns: 260px 1fr; gap:10px;
  padding:10px; overflow:hidden; /* page scroll locked; inner areas scroll */
}
@media (max-width: 900px){ .content{ grid-template-columns: 1fr; } }

.sidebar{
  background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:100%;
}
.sidebar h3{margin:10px 12px;font-size:13px;opacity:.9}
.nav{list-style:none;margin:0;padding:6px}
.nav button{
  width:100%; text-align:left; display:block; border:0; background:transparent; color:var(--ink);
  padding:10px 12px; border-radius:10px; cursor:pointer;
}
.nav button.active{background:#0e1a28; border:1px solid #1d3a54}
.nav button:hover{background:#0d1620}

.main{
  background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:100%;
  display:flex; flex-direction:column;
}
.sectionHead{position:sticky;top:0;background:#0f1720;border-bottom:1px solid var(--line);padding:10px 12px;z-index:1}
.sectionBody{padding:10px 12px; display:grid; gap:10px}

.tiles{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px}
.tile{
  background:linear-gradient(180deg,var(--tile),var(--tile2));
  border:1px solid var(--tileEdge); border-radius:14px; padding:12px; cursor:pointer;
  min-height:88px; display:flex; flex-direction:column; gap:6px; transition:transform .06s ease,border-color .1s ease,background .1s ease;
}
.tile:hover{transform:translateY(-1px)}
.tile.active{border-color:var(--ok); background:var(--tileActive)}
.tile .img{height:34px;background:url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right/contain no-repeat;opacity:.9}
.tile .t{font-weight:700}
.small{font-size:12px;opacity:.85}

.input, textarea{
  width:100%; background:#0a121c; color:var(--ink); border:1px solid #1a2b3d; border-radius:10px; padding:10px 12px; outline:none
}
textarea{resize:vertical;min-height:84px}

.row{display:flex;gap:8px;flex-wrap:wrap}
.badge{font-size:12px;opacity:.85}

.footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:#0c151f;border-top:1px solid var(--line)}
.btn{appearance:none;border:1px solid #21405a;background:#112233;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.primary{border-color:#1f4d83;background:#113459}
.btn.good{border-color:#1c5f3a;background:#0f2a1c}
.btn.warn{border-color:#735a1a;background:#2b2410}
.btn:active{transform:translateY(1px)}

.copybox{white-space:pre-wrap;background:#0a121c;border:1px solid #1a2b3d;border-radius:10px;padding:10px;max-height:32dvh;overflow:auto}

.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
.modal{width:min(720px,96vw);background:#0e1722;border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.show{display:flex!important}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand"><span class="dot"></span><span>Notes&nbsp;Elite</span></div>
    <div class="hint">Scroll the left list and the right content. Build JSON below.</div>
  </div>

  <div class="content">
    <!-- LEFT: sections list (scrolls) -->
    <aside class="sidebar" id="sidebar">
      <h3>Sections</h3>
      <ul class="nav" id="nav">
        <!-- order matches user screenshot + extras requested -->
        <!-- We keep ids stable to map data -->
        <li><button data-target="Needs" class="active">Needs</button></li>
        <li><button data-target="Working at heights">Working at heights</button></li>
        <li><button data-target="System characteristics">System characteristics</button></li>
        <li><button data-target="Arse_cover_notes">Arse_cover_notes</button></li>
        <li><button data-target="Components that require assistance">Components that require assistance</button></li>
        <li><button data-target="Restrictions to work">Restrictions to work</button></li>
        <li><button data-target="External hazards">External hazards</button></li>
        <li><button data-target="Delivery notes">Delivery notes</button></li>
        <li><button data-target="Office notes">Office notes</button></li>
        <li><button data-target="New boiler and controls">New boiler and controls</button></li>
        <li><button data-target="Flue">Flue</button></li>
        <li><button data-target="Pipe work">Pipe work</button></li>
        <li><button data-target="Disruption">Disruption</button></li>
        <!-- Extras you asked for explicitly -->
        <li><button data-target="Gas">Gas</button></li>
        <li><button data-target="Condensate">Condensate</button></li>
        <li><button data-target="Boiler">Boiler</button></li>
        <li><button data-target="Flush">Flush</button></li>
        <li><button data-target="Filter">Filter</button></li>
        <li><button data-target="Controls">Controls</button></li>
        <li><button data-target="Cylinder">Cylinder</button></li>
        <li><button data-target="Radiators">Radiators</button></li>
        <!-- Always present -->
        <li><button data-target="Customer actions">Customer actions</button></li>
        <li><button data-target="Summary">Summary (JSON)</button></li>
      </ul>
    </aside>

    <!-- RIGHT: active section (scrolls) -->
    <main class="main" id="main">
      <!-- The section panels are generated by JS using CONFIG below -->
    </main>
  </div>

  <div class="footer">
    <button class="btn" id="btnBuild">Build JSON</button>
    <button class="btn primary" id="btnCopy">Copy JSON</button>
    <button class="btn good" id="btnDownload">Download JSON</button>
    <button class="btn warn" id="btnReset">Reset</button>
  </div>
</div>

<!-- What3Words (manual; no API dependency) -->
<div class="modalBack" id="w3wModal">
  <div class="modal">
    <strong>What3Words (manual)</strong>
    <input class="input" id="w3wInput" placeholder="filled.count.soap  or  50.7341,-1.7763"/>
    <div class="row">
      <button class="btn" id="w3wValidate">Validate format</button>
      <button class="btn" id="w3wGPS">Use device GPS</button>
      <span class="badge" id="w3wStatus">Idle</span>
    </div>
    <div class="row">
      <button class="btn primary" id="w3wSave">Save</button>
      <button class="btn" id="w3wClose">Close</button>
    </div>
    <span class="small">We store what you enter — no network calls.</span>
  </div>
</div>

<script>
/* =========================
   CONFIG: Tiles per section
   (add/rename freely — UI builds itself)
   ========================= */
const CONFIG = {
  "Needs": {
    type:"multi",
    tiles:[
      "Hot water priority","Keep existing controls","Budget sensitive",
      "Low disruption preferred","Future heat pump ready"
    ]
  },
  "Working at heights": { type:"multi", tiles:["Roof work","Ladder only","Scaffold required","Loft access OK"] },
  "System characteristics": {
    type:"multi",
    tiles:["Microbore present","Sealed system","Open vented","Low mains pressure","Water softener on site"]
  },
  "Arse_cover_notes": { type:"multi", tiles:["Customer informed of shutting water","Customer retains old boiler","Customer to clear access"] },
  "Components that require assistance": { type:"multi", tiles:["Heavy cylinder","Boiler in loft","Access steps","Difficult flue route"] },
  "Restrictions to work": { type:"multi", tiles:["No weekend work","Noise restrictions","Permit for parking","No rear access"] },
  "External hazards": { type:"multi", tiles:["Asbestos suspected","Vermin evidence","Mould/damp present","Combustibles near boiler"] },
  "Delivery notes": {
    type:"multi",
    tiles:["On drive","On street (near)","On street (far)","Permit required","Steps","Tight access","No rear access","Height restriction"],
    w3w:true  // enables W3W control in this section
  },
  "Office notes": { type:"multi", tiles:["Book electrician","Book roofer","Arrange G3 engineer","Order long flue kit"] },
  "New boiler and controls": {
    type:"multi",
    tiles:["Combi","System","Regular","Weather comp","OpenTherm/Bus","Smart stat","Zoning"]
  },
  "Flue": { type:"single", tiles:["Horizontal","Vertical pitched","Vertical flat","Direct rear","Balanced"] },
  "Pipe work": { type:"multi", tiles:["Gas upgrade likely","Condensate upgrade 32mm","Bypass required","Reroute pipework"] },
  "Disruption": { type:"multi", tiles:["1 day","2 days",">2 days","Some redecoration","Significant making good"] },
  "Gas": { type:"single", tiles:["Meter internal","Meter external","Unknown"], extras:["Pipe 22 mm","Pipe 28 mm","Mixed/unknown"] },
  "Condensate": { type:"single", tiles:["Internal to waste","External run","Pump required"] },
  "Boiler": { type:"single", tiles:["Kitchen","Utility","Airing cupboard","Loft"] },
  "Flush": { type:"single", tiles:["Chemical flush","Powerflush","No flush required"] },
  "Filter": { type:"single", tiles:["Magnetic filter","Strainer","No filter"] },
  "Controls": { type:"multi", tiles:["Weather comp","OpenTherm/Bus","Smart stat","Wired centre present","Wireless stat"] },
  "Cylinder": { type:"single", tiles:["Unvented","Vented (F&E)","No cylinder"] },
  "Radiators": { type:"multi", tiles:["TRVs present","TRVs missing on some","Microbore","Add towel rail"] },
  "Customer actions": { type:"multi", tiles:["Clear access","Provide parking permit","Top-up credit meter","Move pets"] },
  "Summary": { type:"summary" }
};

/* =========================
   STATE & helpers
   ========================= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const state = Object.assign({
  selections: {},   // { section : { value: boolean } }
  notes: {},        // { section : "free text" }
  custom: {},       // { section : ["custom line", ...] }
  extras: {},       // for small key/value bits per section
  w3w: null         // { words? , coords? , raw? }
}, load());

function save(){ localStorage.setItem('notes-elite-sections', JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem('notes-elite-sections')||'{}'); }catch{ return {}; } }
function listOf(group){ return group ? Object.keys(group).filter(k=>group[k]) : []; }
function oneOf(group){ if(!group) return ""; const k = Object.keys(group).find(x=>group[x]); return k||""; }
function isThreeWords(s){ return /^[a-z]+\.([a-z]+)\.([a-z]+)$/i.test(s.trim().replace(/^\/+/,'')); }
function isLatLng(s){ return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test(s.trim()); }

/* =========================
   BUILD UI
   ========================= */
const main = $('#main');
for (const [section, cfg] of Object.entries(CONFIG)){
  const panel = document.createElement('section');
  panel.className = 'panel';
  panel.dataset.section = section;

  panel.innerHTML = `
    <div class="sectionHead"><strong>${section}</strong></div>
    <div class="sectionBody">
      ${cfg.type!=="summary" ? `<div class="tiles" data-tiles></div>` : `
        <div class="row">
          <button class="btn" id="buildNow">Build JSON</button>
          <button class="btn primary" id="copyNow">Copy JSON</button>
          <button class="btn good" id="downloadNow">Download JSON</button>
        </div>
        <div id="jsonPreview" class="copybox" aria-live="polite">No JSON yet.</div>
      `}
      ${cfg.w3w ? `
      <div class="row">
        <button class="btn" id="openW3W">What3Words…</button>
        <span class="badge">Saved: <strong id="w3wView">—</strong></span>
      </div>` : ``}
      ${cfg.extras ? `
      <div class="row">
        ${cfg.extras.map(x=>`<label class="small"><input type="checkbox" data-extra="${x}"/> ${x}</label>`).join(' ')}
      </div>` : ``}
      ${cfg.type!=="summary" ? `
      <textarea class="input" placeholder="Free-text notes for '${section}'…"
        data-notes></textarea>
      <div class="row">
        <input class="input" placeholder="Add custom line…" data-custom-input />
        <button class="btn" data-custom-add>Add</button>
      </div>
      <div class="small" data-custom-list></div>
      ` : ``}
    </div>
  `;
  main.appendChild(panel);

  // populate tiles
  if (cfg.type!=="summary"){
    const wrap = panel.querySelector('[data-tiles]');
    (cfg.tiles||[]).forEach(label=>{
      const div = document.createElement('div');
      div.className = 'tile';
      div.innerHTML = `<div class="img"></div><div class="t">${label}</div>`;
      div.dataset.value = label;
      div.dataset.mode = cfg.type; // single or multi
      wrap.appendChild(div);
    });
  }
}

/* =========================
   SIDEBAR NAV
   ========================= */
const panels = Array.from($$('.panel'));
panels[0].classList.add('active'); // first visible
function show(section){
  panels.forEach(p=>p.style.display = (p.dataset.section===section) ? 'block':'none');
  $$('#nav button').forEach(b=> b.classList.toggle('active', b.dataset.target===section));
  // ensure right column scrolls
  $('#main').scrollTop = 0;
}
show('Needs');
$('#nav').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-target]'); if(!b) return;
  show(b.dataset.target);
});

/* =========================
   TILE EVENTS + restore state
   ========================= */
function toggleTile(section, el){
  const val = el.dataset.value, mode = el.dataset.mode;
  state.selections[section] = state.selections[section] || {};
  if (mode === 'single'){
    // clear siblings
    [...el.parentElement.children].forEach(sib=>{
      sib.classList.remove('active');
      if (sib!==el && state.selections[section]) delete state.selections[section][sib.dataset.value];
    });
    state.selections[section][val] = true;
    el.classList.add('active');
  } else {
    state.selections[section][val] = !state.selections[section][val];
    el.classList.toggle('active', !!state.selections[section][val]);
  }
  save();
}

panels.forEach(panel=>{
  const section = panel.dataset.section;

  // tiles
  panel.querySelectorAll('.tile').forEach(tile=>{
    // restore active
    if (state.selections?.[section]?.[tile.dataset.value]) tile.classList.add('active');
    tile.addEventListener('click', ()=> toggleTile(section, tile));
  });

  // notes
  const ta = panel.querySelector('[data-notes]');
  if (ta){
    ta.value = state.notes?.[section] || '';
    ta.addEventListener('input', e=>{ state.notes[section] = e.target.value; save(); });
  }

  // custom lines
  const addBtn = panel.querySelector('[data-custom-add]');
  if (addBtn){
    const input = panel.querySelector('[data-custom-input]');
    const list = panel.querySelector('[data-custom-list]');
    function renderCustom(){
      const arr = state.custom?.[section] || [];
      list.innerHTML = arr.map((t,i)=>`<span class="badge">• ${t} <a href="#" data-del="${i}">×</a></span>`).join(' ');
    }
    renderCustom();
    addBtn.addEventListener('click', ()=>{
      const v = (input.value||'').trim(); if(!v) return;
      state.custom[section] = state.custom[section] || [];
      state.custom[section].push(v); input.value='';
      save(); renderCustom();
    });
    list.addEventListener('click', e=>{
      const idx = e.target.getAttribute('data-del'); if(idx===null) return;
      state.custom[section].splice(+idx,1); save(); renderCustom();
      e.preventDefault();
    });
  }

  // extras (checkbox bits)
  panel.querySelectorAll('input[type="checkbox"][data-extra]').forEach(ch=>{
    const key = ch.getAttribute('data-extra');
    const map = state.extras[section] = state.extras[section] || {};
    ch.checked = !!map[key];
    ch.addEventListener('change', ()=>{ map[key]=ch.checked; save(); });
  });

  // W3W in Delivery notes
  if (CONFIG[section]?.w3w){
    panel.querySelector('#openW3W').addEventListener('click', ()=> $('#w3wModal').classList.add('show'));
    if (state.w3w) panel.querySelector('#w3wView').textContent =
      state.w3w.words ? `///${state.w3w.words}` :
      (state.w3w.coords ? `${state.w3w.coords.lat},${state.w3w.coords.lng}` : (state.w3w.raw||'—'));
  }

  // Summary panel controls
  if (section==='Summary'){
    panel.querySelector('#buildNow').addEventListener('click', ()=>{ $('#jsonPreview').textContent = JSON.stringify(buildJSON(), null, 2); });
    panel.querySelector('#copyNow').addEventListener('click', ()=> navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2)));
    panel.querySelector('#downloadNow').addEventListener('click', downloadJSON);
  }
});

/* =========================
   W3W Modal (manual only)
   ========================= */
$('#w3wClose').onclick = ()=> $('#w3wModal').classList.remove('show');
$('#w3wGPS').onclick = ()=> navigator.geolocation?.getCurrentPosition(
  pos => { $('#w3wInput').value = `${pos.coords.latitude},${pos.coords.longitude}`; $('#w3wStatus').textContent='GPS captured'; },
  ()=> $('#w3wStatus').textContent='GPS unavailable'
);
$('#w3wValidate').onclick = ()=>{
  const s = ($('#w3wInput').value||'').trim();
  if (isThreeWords(s)) return $('#w3wStatus').textContent = '✓ three words format';
  if (isLatLng(s))    return $('#w3wStatus').textContent = '✓ lat,long format';
  $('#w3wStatus').textContent = 'Not recognised (will store raw)';
};
$('#w3wSave').onclick = ()=>{
  const s = ($('#w3wInput').value||'').trim().replace(/^\/+/,'');
  if (!s){ $('#w3wStatus').textContent='Nothing entered'; return; }
  if (isThreeWords(s)) state.w3w = {words:s.toLowerCase()};
  else if (isLatLng(s)){ const [lat,lng]=s.split(',').map(x=>+x.trim()); state.w3w = {coords:{lat,lng}}; }
  else state.w3w = {raw:s};
  // write back into the Delivery panel label if present
  const dv = $('#main [data-section="Delivery notes"] #w3wView');
  if (dv) dv.textContent = state.w3w.words ? `///${state.w3w.words}` :
             (state.w3w.coords ? `${state.w3w.coords.lat},${state.w3w.coords.lng}` : (state.w3w.raw||'—'));
  save(); $('#w3wModal').classList.remove('show');
};

/* =========================
   JSON BUILD
   ========================= */
function buildJSON(){
  // Transform state into your depot JSON (one object with sections)
  const out = { meta:{
      generatedAt: new Date().toISOString(),
      what3words: state.w3w || null
    }, sections:{} };

  for (const name of Object.keys(CONFIG)){
    if (name==='Summary') continue;
    const picks = listOf(state.selections[name]);
    const notes = state.notes?.[name] || '';
    const custom = state.custom?.[name] || [];
    const extrasMap = state.extras?.[name] || {};
    const extras = listOf(extrasMap);

    // Join everything into a plain-English paragraph for this section
    const parts = [];
    if (picks.length) parts.push(picks.join('; '));
    if (extras.length) parts.push(`Extras: ${extras.join('; ')}`);
    if (custom.length) parts.push(custom.map(x=>`• ${x}`).join(' '));
    if (notes) parts.push(notes);

    out.sections[name] = parts.join(' ').trim();
  }
  return out;
}

/* =========================
   Footer buttons
   ========================= */
function downloadJSON(){
  const data = buildJSON();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `depot-notes_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.click();
}
$('#btnBuild').onclick = ()=> {
  const data = buildJSON();
  // jump to Summary and show it
  show('Summary');
  const preview = $('#jsonPreview');
  if (preview) preview.textContent = JSON.stringify(data, null, 2);
};
$('#btnCopy').onclick = ()=> navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2));
$('#btnDownload').onclick = downloadJSON;
$('#btnReset').onclick = ()=>{ localStorage.removeItem('notes-elite-sections'); location.reload(); };

/* Show first panel content only (others hidden) */
panels.forEach(p=> p.style.display = (p.dataset.section==='Needs' ? 'block':'none'));
</script>
</body>
</html>
