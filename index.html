<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Notes Elite ‚Äî New UI</title>
<meta name="theme-color" content="#0a0e13" />

<!-- ‚ö†Ô∏è BRANDING: we only borrow GRAPHICS (no CSS/JS) from Fast-survey -->
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg">
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg">

<style>
/* =========================
   NEW, STANDALONE UI (no FS CSS)
   Goals:
   - No body scrolling jiggle
   - Fixed frame with internal scroll areas
   - Zero horizontal overflow
   - Efficient information density
   ========================= */
:root{
  --bg: #0a0e13;
  --bg-elev: #0d141b;
  --panel: #0f1722;
  --muted: #c8d4e1;
  --soft: #1b2836;
  --brand: #7cc4ff;
  --ok: #35b470;
  --warn: #f6c14b;
  --danger: #ff6a6a;
  --ink: #e8f0f6;
  --shadow: 0 1px 0 rgba(255,255,255,.02) inset, 0 12px 50px rgba(0,0,0,.35);
}

*{ box-sizing: border-box; }
html,body{ height:100%; }
html{ color-scheme: dark; }
body{
  margin:0; background: var(--bg); color: var(--ink);
  font: 14.5px/1.45 ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  overflow:hidden; /* üëâ kill page scroll; we control it */
}

/* App frame */
.app{
  height: 100dvh; /* full viewport, mobile safe */
  display: grid;
  grid-template-rows: 56px 1fr 52px; /* header + content + action bar */
  grid-template-columns: 100%;
  background:
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right -40px top -40px/220px no-repeat,
    url("https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg") left -40px bottom -40px/220px no-repeat,
    linear-gradient(180deg,#0a0e13, #0a0e13 60%, #0b1118);
}

/* Header */
.header{
  display:flex; align-items:center; gap:12px;
  padding:0 14px; background:var(--bg-elev); border-bottom:1px solid #10202d;
}
.header .brand{ display:flex; align-items:center; gap:10px; }
.brand .dot{ width:10px;height:10px;border-radius:50%; background:var(--brand); box-shadow:0 0 10px var(--brand);}
.header .title{ font-weight:700; letter-spacing:.2px }
.header .hint{ margin-left:auto; opacity:.8; font-size:12px }

/* Content split */
.content{
  display:grid; grid-template-columns: 320px 1fr; gap:12px;
  padding:12px; overflow:hidden; /* lock container */
}
@media (max-width: 980px){
  .content{ grid-template-columns: 1fr; }
  .sidebar{ order:2; height:36dvh; }
  .main{ order:1; height: calc(100% - 12px - 12px); }
}

/* Scroll panes */
.sidebar, .main{
  background: var(--panel); border:1px solid #122232; border-radius:16px; box-shadow: var(--shadow);
  overflow:auto; overscroll-behavior: contain;
}

/* Sidebar */
.sidebar .h{ padding:12px 14px; position:sticky; top:0; background:linear-gradient(#101823, #0f1722 80%); border-bottom:1px solid #122232; z-index:1 }
.sidebar .group{ padding:12px; display:grid; gap:12px }

/* Mini cards */
.card{
  background: #0d1620; border:1px solid #132639; border-radius:12px; padding:10px;
}
.card h4{ margin:0 0 8px 0; font-size:13px; letter-spacing:.2px; opacity:.9 }
.card .row{ display:flex; gap:8px; flex-wrap:wrap; }
.card input, .card textarea{
  width:100%; background:#0a121c; color:var(--ink); border:1px solid #1a2b3d;
  padding:10px 11px; border-radius:10px; outline:none;
}
.card textarea{ resize:vertical; min-height:84px; }

/* Tiles */
.tiles{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:10px; }
.tile{
  background:#0a121c; border:1px dashed #24405a; border-radius:12px; padding:10px; cursor:pointer; transition: transform .06s ease;
}
.tile:hover{ transform: translateY(-1px); }
.tile.active{ border-style:solid; border-color: var(--ok); background:#0e1b14; }

/* Main area */
.main .h{ padding:12px 14px; position:sticky; top:0; background:linear-gradient(#101823, #0f1722 80%); border-bottom:1px solid #122232; z-index:1 }
.section-pills{ display:flex; gap:8px; flex-wrap:wrap; padding:12px 12px 0 }
.pill{ border:1px solid #22364a; background:#0b1520; border-radius:999px; padding:6px 10px; font-size:12px; opacity:.95 }

.sections{ padding:12px; display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px }
.section{
  background:#0d1620; border:1px solid #152a3d; border-radius:12px; padding:10px;
}
.section h3{ margin:0 0 8px 0; font-size:15px; }
.copybox{
  background:#0a121c; border:1px solid #192b3c; border-radius:10px; padding:10px; min-height:120px; max-height:220px; overflow:auto; white-space:pre-wrap;
}
.section textarea{ margin-top:8px }

/* Action bar */
.actions{
  display:flex; gap:8px; align-items:center; justify-content:center;
  padding:8px; background:var(--bg-elev); border-top:1px solid #10202d;
}
.btn{
  appearance:none; border:1px solid #21405a; background:#112233; color:var(--ink);
  padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
}
.btn.primary{ border-color:#1f4d83; background:#113459; }
.btn.good{ border-color:#1c5f3a; background:#0f2a1c; }
.btn:active{ transform: translateY(1px); }

/* Helpers */
.kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0a121c; border:1px solid #1f2a37; border-bottom-width:2px;border-radius:6px;padding:2px 6px }
.badge{ font-size:12px; opacity:.85; }
hr{ border:0; border-top:1px solid #122232; margin:10px 0; }
.hidden{ display:none !important; }
.toast{
  position:fixed; right:12px; bottom:12px; background:#0f1f15; border:1px solid #1f3b2a;
  padding:10px 12px; border-radius:12px; box-shadow: var(--shadow);
}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="brand"><span class="dot"></span><span class="title">Notes&nbsp;Elite</span></div>
    <span class="badge">New frame ‚Ä¢ zero dead space</span>
    <div class="hint">Tip: <span class="kbd">‚åò</span>/<span class="kbd">Ctrl</span>+<span class="kbd">K</span> to build</div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="h"><strong>Inputs</strong></div>
      <div class="group">

        <div class="card">
          <h4>üìç What3Words</h4>
          <input id="w3wInput" placeholder="filled.count.soap  or  50.7341,-1.7763" />
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnResolveW3W">Resolve</button>
            <button class="btn" id="btnGPS">Use GPS</button>
          </div>
          <div id="w3wBadge" class="badge" style="display:block;margin-top:8px;opacity:.9">No location yet</div>
        </div>

        <div class="card">
          <h4>üß† Readability (Cloudflare)</h4>
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="chkReadable" checked> Enable</label>
          <input id="readableEndpoint" placeholder="https://survey-brain-api.martinbibb.workers.dev/clean" style="margin-top:6px" />
        </div>

        <div class="card">
          <h4>üì° Background telemetry</h4>
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="chkTelemetry"> Send anonymised schema</label>
          <input id="telemetryEndpoint" placeholder="https://survey-brain-api.martinbibb.workers.dev/telemetry" style="margin-top:6px" />
          <small class="badge">Section counts only ‚Äî no PII unless added by you.</small>
        </div>

        <div class="card">
          <h4>üîó Depot Options.txt</h4>
          <input id="optionsUrl" value="https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/refs/heads/main/Options.txt" />
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnLoadOptions">Load</button>
            <span id="optionsStatus" class="badge" style="align-self:center">idle</span>
          </div>
        </div>

        <div class="card">
          <h4>üß© System recommendation</h4>
          <input id="sysHeadline" placeholder="e.g. Vaillant ecoFIT system + Mixergy 210L" />
          <textarea id="sysWhy" placeholder="Why this system? Heat-loss, DHW demand, flue route, controls‚Ä¶"></textarea>
        </div>

        <div class="card">
          <h4>üöø Hot-Water Model</h4>
          <iframe id="hotWaterFrame" loading="lazy" style="width:100%;height:260px;border:1px solid #1b3146;border-radius:10px"
            src="https://martinbibb-cmd.github.io/Depot-notes/hot-water-model.html"></iframe>
          <small class="badge">Summary auto-includes on export if the model posts <code>HOT_WATER_SUMMARY</code>.</small>
        </div>

      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="main">
      <div class="h"><strong>Composer</strong></div>

      <section style="padding:0 12px 6px">
        <div class="tiles" id="optionsTiles">
          <!-- dynamic tiles from Options.txt -->
        </div>
      </section>

      <section class="section-pills" id="sectionPills"></section>

      <section class="sections" id="sectionsGrid"></section>
    </main>
  </div>

  <!-- ACTION BAR -->
  <div class="actions">
    <button class="btn" id="btnBuild">Build Draft</button>
    <button class="btn" id="btnClean">Clean via Cloudflare</button>
    <button class="btn" id="btnCopy">Copy Text</button>
    <button class="btn good" id="btnJSON">Download JSON</button>
    <button class="btn" id="btnReset">Reset</button>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* =========================
   STATE
   ========================= */
const $ = (id)=>document.getElementById(id);
const state = Object.assign({
  sections:{},          // free text user edits
  selected:{},          // { SectionName: { idx: true } }
  optionsText:'',       // raw Options.txt
  optionsUrl: $('optionsUrl').value,
  sys:{ headline:'', why:'' },
  w3w:null,
  hotWaterSummary:'',
  readableEndpoint: '',
  telemetryEndpoint: '',
  readableEnabled: true,
  telemetryEnabled: false
}, load());
let parsedOptions = state.optionsText ? parseOptions(state.optionsText) : {};

applyInitial();
renderSections();

if(state.optionsText){
  renderTiles();
  $('optionsStatus').textContent = 'loaded';
}else{
  loadOptions();
}

/* =========================
   LAYOUT SANITY: no horizontal overflow EVER
   ========================= */
(function lockHorizontal(){
  const killers = [document.documentElement, document.body];
  const clamp = ()=> killers.forEach(el=> el.style.overflowX='hidden');
  window.addEventListener('resize', clamp, {passive:true});
  clamp();
})();

/* =========================
   STORAGE
   ========================= */
function save(){ localStorage.setItem('notes-elite-v2', JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem('notes-elite-v2')||'{}'); }catch{ return {}; } }
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); }

/* =========================
   OPTIONS.TXT PARSER
   ========================= */
function parseOptions(txt){
  const lines = txt.split(/\r?\n/);
  const out = {}; let cur = null;
  for(const raw of lines){
    const line = raw.trim();
    if(!line) continue;
    const m = line.match(/^\[(.+?)\]$/);
    if(m){ cur=m[1]; if(!out[cur]) out[cur]=[]; continue; }
    if(line.startsWith('- ')){ out[cur]=out[cur]||[]; out[cur].push(line.slice(2)); continue; }
    const kv = line.match(/^([^:]+):\s*(.+)$/);
    if(kv){ out[cur]=out[cur]||[]; out[cur].push(kv[1].trim()+': '+kv[2].trim()); continue; }
    if(cur){ out[cur].push(line); }
  }
  return out;
}

/* =========================
   RENDER: Tiles + Sections
   ========================= */
const DEFAULT_SECTIONS = [
  "Customer details","Property","Existing system","New system","Flue & terminal",
  "Condensate & waste","Gas & meter","Electrical & controls","Cylinders & HW",
  "Access & WAH","H&S / Asbestos","Observations","System recommendation"
];

function renderTiles(){
  const wrap = $('optionsTiles');
  wrap.innerHTML = '';
  Object.entries(parsedOptions).forEach(([section, items])=>{
    // section heading card
    const sectionCard = document.createElement('div');
    sectionCard.className = 'tile';
    sectionCard.style.borderStyle='solid';
    sectionCard.style.background='#0e1a28';
    sectionCard.style.cursor='default';
    sectionCard.innerHTML = `<strong>${section}</strong><br><span class="badge">Tap to add lines below</span>`;
    wrap.appendChild(sectionCard);

    // items
    items.forEach((text, idx)=>{
      const t = document.createElement('div');
      t.className='tile';
      t.textContent = text;
      t.dataset.section = section;
      t.dataset.idx = idx;
      if(state.selected?.[section]?.[idx]) t.classList.add('active');
      t.onclick = ()=> toggleTile(t);
      wrap.appendChild(t);
    });
  });
  renderSections();
}

function toggleTile(el){
  const s = el.dataset.section, i = el.dataset.idx;
  state.selected[s] = state.selected[s] || {};
  state.selected[s][i] = !state.selected[s][i];
  el.classList.toggle('active', !!state.selected[s][i]);
  save();
  renderSections();
}

function renderSections(){
  const pills = $('sectionPills'); pills.innerHTML='';
  const grid = $('sectionsGrid'); grid.innerHTML='';

  const names = Array.from(new Set([...DEFAULT_SECTIONS, ...Object.keys(state.selected||{})]));
  names.forEach(name=>{
    const pill = document.createElement('span');
    pill.className='pill'; pill.textContent=name; pills.appendChild(pill);

    const card = document.createElement('div'); card.className='section';
    const h = document.createElement('h3'); h.textContent=name; card.appendChild(h);

    const copy = document.createElement('div'); copy.className='copybox';
    copy.textContent = composeSection(name);
    card.appendChild(copy);

    const ta = document.createElement('textarea'); ta.placeholder='Add/override notes‚Ä¶'; ta.rows=6;
    ta.value = state.sections?.[name]?.free || '';
    ta.oninput = ()=>{
      state.sections[name]=state.sections[name]||{};
      state.sections[name].free = ta.value;
      save();
      copy.textContent = composeSection(name);
    };
    card.appendChild(ta);

    grid.appendChild(card);
  });
}

function composeSection(name){
  const parsed = parsedOptions;
  const sel = state.selected?.[name] || {};
  const lines = [];
  if(parsed[name]) parsed[name].forEach((t,i)=>{ if(sel[i]) lines.push('‚Ä¢ '+t); });
  if(name==='System recommendation'){
    if(state.sys.headline) lines.unshift('Recommendation: '+state.sys.headline);
    if(state.sys.why) lines.push('Why: '+state.sys.why);
    if(state.hotWaterSummary) lines.push('Hot-water model: '+state.hotWaterSummary);
    if(state.w3w?.words) lines.push('What3Words: ///'+state.w3w.words);
  }
  if(state.sections?.[name]?.free) lines.push(state.sections[name].free);
  return lines.join('\n');
}

/* =========================
   LOAD & BOOTSTRAP
   ========================= */
async function loadOptions(){
  $('optionsStatus').textContent='loading‚Ä¶';
  try{
    const url = $('optionsUrl').value.trim();
    const r = await fetch(url, {cache:'no-store'});
    const t = await r.text();
    state.optionsUrl = url;
    state.optionsText = t; save();
    parsedOptions = parseOptions(t);
    renderTiles();
    $('optionsStatus').textContent='loaded';
  }catch(e){
    $('optionsStatus').textContent='error';
    toast('Failed to load Options.txt');
  }
}
$('btnLoadOptions').onclick = loadOptions;

/* =========================
   WHAT3WORDS
   ========================= */
const W3W_PROXY = 'https://w3w-proxy.martinbibb.workers.dev';
$('btnResolveW3W').onclick = ()=> resolveW3W($('w3wInput').value);
$('btnGPS').onclick = ()=> navigator.geolocation?.getCurrentPosition(
  pos => resolveW3W(`${pos.coords.latitude},${pos.coords.longitude}`),
  ()=> toast('GPS unavailable')
);

async function resolveW3W(val){
  const s = (val||'').trim();
  if(!s){ toast('Enter three words or lat,lng'); return; }
  const coord = s.match(/^\s*(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)\s*$/);
  try{
    let result;
    if(coord){
      const url = `${W3W_PROXY}/convert-to-3wa?lat=${coord[1]}&lng=${coord[3]}`;
      result = await fetch(url).then(r=>r.json());
      if(!result?.words) result = { coordinates:{lat:+coord[1],lng:+coord[3]}, words:null };
    }else{
      const words = s.replace(/^\/+/, '').replace(/^w3w:/,'');
      const url = `${W3W_PROXY}/convert-to-coords?words=${encodeURIComponent(words)}`;
      result = await fetch(url).then(r=>r.json());
      result.words = result.words || words;
    }
    state.w3w = result; save();
    $('w3wBadge').textContent = result.words ? `///${result.words}` :
      result.coordinates ? `${result.coordinates.lat},${result.coordinates.lng}` : 'Unresolved';
    renderSections();
  }catch{
    $('w3wBadge').textContent = 'Unresolved';
  }
}

/* =========================
   HOT WATER SUMMARY BRIDGE
   ========================= */
window.addEventListener('message', (evt)=>{
  try{
    if(evt.data && evt.data.type === 'HOT_WATER_SUMMARY'){
      state.hotWaterSummary = (evt.data.summary||'').toString();
      save(); renderSections(); toast('Hot-water summary received');
    }
  }catch{}
});

/* =========================
   BUILD / CLEAN / EXPORT
   ========================= */
function buildDraft(){
  const names = Array.from(new Set([...DEFAULT_SECTIONS, ...Object.keys(state.selected||{})]));
  const by = {};
  names.forEach(n=> by[n] = composeSection(n).trim());
  const txt = Object.entries(by).filter(([,v])=>v).map(([k,v])=>`# ${k}\n${v}`).join('\n\n');
  state.lastBuilt = { by, txt, ts: Date.now() }; save();
  return txt;
}
async function cleanDraft(){
  if(!$('chkReadable').checked){ toast('Readability disabled'); return; }
  const ep = $('readableEndpoint').value.trim(); if(!ep){ toast('No readability endpoint'); return; }
  const txt = state.lastBuilt?.txt || buildDraft();
  try{
    const r = await fetch(ep, {method:'POST', headers:{'content-type':'text/plain'}, body: txt});
    const t = await r.text();
    state.lastBuilt.txt = t; save();
    toast('Cleaned');
  }catch{ toast('Clean failed'); }
}
function copyText(){
  const txt = state.lastBuilt?.txt || buildDraft();
  navigator.clipboard.writeText(txt).then(()=>toast('Copied'));
}
function downloadJSON(){
  if(!state.lastBuilt?.by){ buildDraft(); }
  const by = state.lastBuilt?.by || {};
  const out = {
    meta:{ createdAt:new Date().toISOString(), w3w: state.w3w || null },
    sections: by
  };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `depot-notes_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  a.click();
}

$('btnBuild').onclick = ()=> { buildDraft(); toast('Draft built'); maybeTelemetry(); };
$('btnClean').onclick = cleanDraft;
$('btnCopy').onclick = copyText;
$('btnJSON').onclick = downloadJSON;

/* telemetry */
function maybeTelemetry(){
  if(!$('chkTelemetry').checked) return;
  const ep = $('telemetryEndpoint').value.trim(); if(!ep) return;
  const schema = {
    ts: Date.now(),
    sections: Object.keys(state.selected||{}).length,
    counts: Object.fromEntries(Object.entries(state.selected||{}).map(([k,v])=>[k, Object.values(v).filter(Boolean).length])),
    hasW3W: !!state.w3w?.words
  };
  fetch(ep, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(schema)}).catch(()=>{});
}

/* =========================
   RESET
   ========================= */
$('btnReset').onclick = ()=>{
  localStorage.removeItem('notes-elite-v2');
  location.reload();
};

/* =========================
   UX niceties
   ========================= */
document.addEventListener('keydown', (e)=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('btnBuild').click(); }
});

/* =========================
   INITIAL APPLY
   ========================= */
function applyInitial(){
  $('optionsUrl').value = state.optionsUrl || $('optionsUrl').value;
  $('sysHeadline').value = state.sys.headline || '';
  $('sysWhy').value = state.sys.why || '';
  $('readableEndpoint').value = state.readableEndpoint || $('readableEndpoint').value;
  $('telemetryEndpoint').value = state.telemetryEndpoint || $('telemetryEndpoint').value;
  $('chkReadable').checked = state.readableEnabled ?? true;
  $('chkTelemetry').checked = state.telemetryEnabled ?? false;

  $('sysHeadline').oninput = (e)=>{ state.sys.headline = e.target.value; save(); renderSections(); };
  $('sysWhy').oninput = (e)=>{ state.sys.why = e.target.value; save(); renderSections(); };
  $('readableEndpoint').oninput = (e)=>{ state.readableEndpoint = e.target.value; save(); };
  $('telemetryEndpoint').oninput = (e)=>{ state.telemetryEndpoint = e.target.value; save(); };
  $('chkReadable').onchange = (e)=>{ state.readableEnabled = e.target.checked; save(); };
  $('chkTelemetry').onchange = (e)=>{ state.telemetryEnabled = e.target.checked; save(); };
}
</script>
</body>
</html>
