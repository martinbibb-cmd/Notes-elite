<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Notes Elite — Offline-first</title>
<meta name="theme-color" content="#0b1016"/>
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg">
<link rel="preload" as="image" href="https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg">
<style>
:root{--bg:#0b1016;--panel:#0f1720;--ink:#e8f0f6;--line:#142533;--tile:#0b141f;--tile2:#0d1a26;--tileEdge:#20405a;--tileActive:#0f2218;--brand:#7cc4ff;--ok:#2ecc71;--warn:#ffc857;--err:#ff6a6a}
*{box-sizing:border-box}html,body{height:100%}html{color-scheme:dark}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
.app{height:100dvh;display:grid;grid-template-rows:64px auto 1fr 56px;background:
 url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right -40px top -40px/220px no-repeat,
 url("https://martinbibb-cmd.github.io/Fast-survey/assets/branch.svg") left -40px bottom -40px/220px no-repeat,
 linear-gradient(180deg,#0b1016,#0b1016 60%,#0a0f15)}
.header{display:flex;gap:12px;align-items:center;padding:0 14px;background:#0c151f;border-bottom:1px solid var(--line)}
.brand{display:flex;gap:10px;align-items:center;font-weight:700}.dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 10px var(--brand)}
.toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#0e1722;border-bottom:1px solid var(--line);flex-wrap:wrap}
.input{background:#0a121c;color:var(--ink);border:1px solid #1a2b3d;border-radius:10px;padding:8px 10px}
.btn{appearance:none;border:1px solid #21405a;background:#112233;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.primary{border-color:#1f4d83;background:#113459}.btn.good{border-color:#1c5f3a;background:#0f2a1c}.btn.warn{border-color:#735a1a;background:#2b2410}
.status{font-size:12px}.ok{color:var(--ok)}.bad{color:var(--err)}
.log{font-size:12px;opacity:.85}
.content{display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;overflow:hidden}
@media(max-width:900px){.content{grid-template-columns:1fr}}
.sidebar{background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto}
.sidebar h3{margin:10px 12px;font-size:13px;opacity:.9}
.nav{list-style:none;margin:0;padding:6px}
.nav button{width:100%;text-align:left;border:0;background:transparent;color:var(--ink);padding:10px 12px;border-radius:10px;cursor:pointer}
.nav button.active{background:#0e1a28;border:1px solid #1d3a54}
.main{background:#0f1720;border:1px solid var(--line);border-radius:14px;overflow:auto;display:flex;flex-direction:column}
.sectionHead{position:sticky;top:0;background:#0f1720;border-bottom:1px solid var(--line);padding:10px 12px;z-index:1}
.sectionBody{padding:10px 12px;display:grid;gap:10px}
.tiles{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.group{grid-column:1/-1;font-size:12px;opacity:.85;border-left:3px solid #23445f;padding-left:8px;margin-top:6px}
.tile{background:linear-gradient(180deg,var(--tile),var(--tile2));border:1px solid var(--tileEdge);border-radius:14px;padding:10px;cursor:pointer;min-height:88px;display:flex;flex-direction:column;gap:6px}
.tile.active{border-color:var(--ok);background:var(--tileActive)}
.tile .img{height:24px;background:url("https://martinbibb-cmd.github.io/Fast-survey/assets/leaf.svg") right/contain no-repeat;opacity:.9}
.t{font-weight:700}.badges{display:flex;gap:6px;flex-wrap:wrap;font-size:11px;opacity:.9}
.badge{border:1px solid #23445f;border-radius:8px;padding:2px 6px}
textarea{resize:vertical;min-height:84px}
.copybox{white-space:pre-wrap;background:#0a121c;border:1px solid #1a2b3d;border-radius:10px;padding:10px;max-height:32dvh;overflow:auto}
.footer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:#0c151f;border-top:1px solid var(--line)}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
.modal{width:min(720px,96vw);background:#0e1722;border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px}
.show{display:flex!important}
</style>
</head>
<body>
<div class="app">
  <div class="header"><div class="brand"><span class="dot"></span><span>Notes&nbsp;Elite</span></div><div class="log" id="log"></div></div>

  <div class="toolbar">
    <span class="status" id="status">Idle</span>
    <input id="url" class="input" placeholder="Options.txt URL (defaults to jsDelivr)"/>
    <button class="btn" id="btnFetch">Fetch</button>
    <input type="file" id="file" accept=".txt" class="input"/>
    <button class="btn" id="btnPaste">Paste text…</button>
    <button class="btn primary" id="btnReload">Rebuild UI</button>
  </div>

  <div class="content">
    <aside class="sidebar">
      <h3>Sections</h3>
      <ul class="nav" id="nav"></ul>
    </aside>
    <main class="main" id="main"></main>
  </div>

  <div class="footer">
    <button class="btn" id="btnBuild">Build JSON</button>
    <button class="btn primary" id="btnCopy">Copy JSON</button>
    <button class="btn good" id="btnDownload">Download JSON</button>
    <button class="btn warn" id="btnReset">Reset</button>
  </div>
</div>

<!-- What3Words (manual) -->
<div class="modalBack" id="w3wModal">
  <div class="modal">
    <strong>What3Words (manual)</strong>
    <input class="input" id="w3wInput" placeholder="filled.count.soap  or  50.7341,-1.7763"/>
    <div><button class="btn" id="w3wValidate">Validate</button> <button class="btn" id="w3wGPS">Use GPS</button> <span id="w3wStatus" class="status">Idle</span></div>
    <div><button class="btn primary" id="w3wSave">Save</button> <button class="btn" id="w3wClose">Close</button></div>
    <div class="status">Stored locally — no API calls.</div>
  </div>
</div>

<script>
/* ---------- Constants ---------- */
const DEFAULT_URL = "https://cdn.jsdelivr.net/gh/martinbibb-cmd/Depot-notes@main/Options.txt";
const RAW_URL     = "https://raw.githubusercontent.com/martinbibb-cmd/Depot-notes/main/Options.txt";
const GH_HTML     = "https://github.com/martinbibb-cmd/Depot-notes/blob/main/Options.txt";

const UI = ["Needs","Working at heights","System characteristics","Arse_cover_notes",
"Components that require assistance","Restrictions to work","External hazards","Delivery notes",
"Office notes","New boiler and controls","Flue","Pipe work","Disruption","Gas","Condensate",
"Boiler","Flush","Filter","Controls","Cylinder","Radiators","Customer actions","Summary"];

const SINGLE = new Set(["Flue","Gas","Condensate","Boiler","Flush","Filter","Cylinder"]);
const W3W_SECTION="Delivery notes";

/* ---------- State ---------- */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const state=Object.assign({selections:{},notes:{},custom:{},w3w:null,parsed:{},map:{}}, load());
function save(){localStorage.setItem('notes-elite-offline',JSON.stringify(state))}
function load(){try{return JSON.parse(localStorage.getItem('notes-elite-offline')||'{}')}catch{return{}}}
function norm(s){return (s||"").toLowerCase().replace(/[_-]/g,' ').replace(/\s+/g,' ').trim()}
function listOf(m){return m?Object.keys(m).filter(k=>m[k]):[]}
function log(msg,cls){const el=$("#log"); el.textContent=msg; el.className=cls||""}

/* ---------- Parsers ---------- */
function parseOptionsPipe(txt){
  const out={}; let cur=null, subgroup=null;
  txt.replace(/\r\n/g,"\n").split("\n").forEach(raw=>{
    const ln=raw.replace(/\s+$/,'');
    const m=ln.match(/^\s*\[(.+?)\]\s*$/); if(m){cur=m[1]; out[cur]=out[cur]||[]; subgroup=null; return}
    if(!cur || !ln.trim()) return;
    if(/^\s*\|[^|]/.test(ln)){subgroup=ln.replace(/^\s*\|/,'').trim(); return}
    const parts=ln.split("|").map(x=>x.trim()).filter(x=>x!==""||x==="0");
    if(parts.length>=2){
      const code=parts[0], category=parts.length>=3?parts[1]:"", text=parts.length>=3?parts.slice(2).join(" | "):parts[1];
      out[cur].push({code,category,text,subgroup});
    }else{
      out[cur].push({code:"",category:"",text:ln.trim(),subgroup});
    }
  });
  return out;
}
function buildMap(parsed){
  const byNorm={}; Object.entries(parsed).forEach(([k,v])=>byNorm[norm(k)]=v);
  const alias={
    "working at heights":["working at height","wah","access & wah","access and wah"],
    "arse_cover_notes":["arse cover notes","cover notes"],
    "system characteristics":["system chars","system"],
    "components that require assistance":["components require assistance"],
    "restrictions to work":["restrictions","work restrictions"],
    "external hazards":["hazards","hazards external"],
    "delivery notes":["delivery","parking","delivery & parking","delivery and parking"],
    "office notes":["office","admin notes"],
    "new boiler and controls":["new boiler","boiler and controls"],
    "pipe work":["pipework","pipe-work"],
    "customer actions":["customer to","customer jobs"]
  };
  const map={};
  UI.forEach(u=>{
    if(u==="Summary"){map[u]=[];return}
    let arr=byNorm[norm(u)];
    if(!arr && alias[norm(u)]){for(const a of alias[norm(u)]){if(byNorm[a]){arr=byNorm[a];break}}}
    map[u]=Array.isArray(arr)?arr:[];
  });
  return map;
}

/* ---------- UI ---------- */
const nav=$("#nav"), main=$("#main");
function buildUI(){
  // build sidebar + panels even if no data
  nav.innerHTML=""; main.innerHTML="";
  UI.forEach((sec,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`<button data-target="${sec}" ${i===0?'class="active"':''}>${sec}</button>`;
    nav.appendChild(li);
    const panel=document.createElement("section"); panel.className="panel"; panel.dataset.section=sec; panel.style.display=(i===0?"block":"none");
    if(sec==="Summary"){
      panel.innerHTML=`<div class="sectionHead"><strong>${sec}</strong></div>
      <div class="sectionBody"><div class="copybox" id="jsonPreview">No JSON yet.</div></div>`;
      main.appendChild(panel); return;
    }
    const items=state.map?.[sec]||[];
    const isSingle=SINGLE.has(sec);
    const w3wCtl=sec===W3W_SECTION;
    panel.innerHTML=`<div class="sectionHead"><strong>${sec}</strong> <span class="status">${items.length?items.length+" options":"no options loaded"}</span></div>
    <div class="sectionBody">
      <div class="tiles" data-tiles></div>
      ${w3wCtl?`<div><button class="btn" id="openW3W">What3Words…</button> <span class="status" id="w3wView">—</span></div>`:""}
      <textarea class="input" data-notes placeholder="Free-text notes for '${sec}'…"></textarea>
      <div><input class="input" data-custom-input placeholder="Add custom line…"/> <button class="btn" data-custom-add>Add</button></div>
      <div class="status" data-custom-list></div>
    </div>`;
    main.appendChild(panel);

    // tiles with subgroup headings
    const wrap=panel.querySelector("[data-tiles]"); let last=null;
    items.forEach(rec=>{
      if(rec.subgroup && rec.subgroup!==last){const g=document.createElement("div"); g.className="group"; g.textContent=rec.subgroup; wrap.appendChild(g); last=rec.subgroup}
      const key=`${rec.code}|${rec.text}`;
      const t=document.createElement("div"); t.className="tile"; if(state.selections?.[sec]?.[key]) t.classList.add("active");
      t.innerHTML=`<div class="img"></div><div class="t">${rec.text||rec.category||rec.code}</div>
                   <div class="badges">${rec.code?`<span class="badge">${rec.code}</span>`:""}${rec.category?`<span class="badge">${rec.category}</span>`:""}${rec.subgroup?`<span class="badge">${rec.subgroup}</span>`:""}</div>`;
      t.onclick=()=>{
        state.selections[sec]=state.selections[sec]||{};
        if(isSingle){[...wrap.querySelectorAll(".tile")].forEach(s=>s.classList.remove("active")); state.selections[sec]={}; state.selections[sec][key]=true; t.classList.add("active")}
        else{const on=!state.selections[sec][key]; state.selections[sec][key]=on; t.classList.toggle("active",on)}
        save();
      };
      wrap.appendChild(t);
    });

    // notes + custom lines
    const ta=panel.querySelector("[data-notes]"); ta.value=state.notes?.[sec]||""; ta.oninput=e=>{state.notes[sec]=e.target.value; save();}
    const input=panel.querySelector("[data-custom-input]"); const list=panel.querySelector("[data-custom-list]");
    function render(){const arr=state.custom?.[sec]||[]; list.innerHTML=arr.map((x,i)=>`• ${x} <a href="#" data-del="${i}">×</a>`).join("  ")}
    render();
    panel.querySelector("[data-custom-add]").onclick=()=>{const v=(input.value||"").trim(); if(!v) return; state.custom[sec]=state.custom[sec]||[]; state.custom[sec].push(v); input.value=""; save(); render();}
    list.onclick=e=>{const i=e.target.getAttribute("data-del"); if(i==null) return; state.custom[sec].splice(+i,1); save(); render(); e.preventDefault();}

    if(w3wCtl){
      panel.querySelector("#openW3W").onclick=()=>$("#w3wModal").classList.add("show");
      panel.querySelector("#w3wView").textContent = state.w3w?.words?`///${state.w3w.words}`:(state.w3w?.coords?`${state.w3w.coords.lat},${state.w3w.coords.lng}`:(state.w3w?.raw||"—"));
    }
  });

  // nav
  $("#nav").onclick=e=>{const b=e.target.closest("button[data-target]"); if(!b) return; $$("#nav button").forEach(bb=>bb.classList.toggle("active",bb===b)); $$(".panel").forEach(p=>p.style.display=(p.dataset.section===b.dataset.target)?"block":"none"); $("#main").scrollTop=0;}

  // preview
  $("#btnBuild").onclick=()=>{$("#jsonPreview").textContent=JSON.stringify(buildJSON(),null,2); const b=[...$$("#nav button")].find(x=>x.dataset.target==='Summary'); b&&b.click();}
  $("#btnCopy").onclick=()=>navigator.clipboard.writeText(JSON.stringify(buildJSON(),null,2));
  $("#btnDownload").onclick=downloadJSON;
  $("#btnReset").onclick=()=>{localStorage.removeItem('notes-elite-offline'); location.reload();};
}

/* ---------- Loader actions ---------- */
async function fetchWithFallback(urls){
  for(const u of urls){
    try{
      $("#status").textContent=`Fetching from ${new URL(u).hostname}…`;
      const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const ct=r.headers.get("content-type")||""; let txt=await r.text();
      if(!/text\/|octet-stream/i.test(ct) && /<html/i.test(txt)){
        const m=txt.match(/<pre[^>]*>([\s\S]*?)<\/pre>/i) || txt.match(/<tbody[^>]*>([\s\S]*?)<\/tbody>/i);
        if(m) txt=m[1].replace(/<[^>]+>/g,'').replace(/&nbsp;/g,' ').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
      }
      $("#status").textContent=`Loaded from ${new URL(u).hostname}`; $("#status").className="status ok";
      return txt;
    }catch(e){ $("#status").textContent=`Failed ${u} (${e.message})`; $("#status").className="status bad"; }
  }
  throw new Error("All sources failed");
}

function applyOptionsText(txt){
  try{
    state.parsed = parseOptionsPipe(txt);
    state.map = buildMap(state.parsed);
    save();
    log(`Parsed ${Object.keys(state.parsed).length} sections`, "ok");
  }catch(e){
    log(`Parse error: ${e.message}`, "bad");
    state.parsed={}; state.map={}; save();
  }
  buildUI();
}

/* ---------- W3W modal ---------- */
function is3w(s){return /^[a-z]+\.([a-z]+)\.([a-z]+)$/i.test((s||'').trim().replace(/^\/+/,''))}
function isLL(s){return /^\s*-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?\s*$/.test((s||'').trim())}
$("#w3wClose").onclick=()=>$("#w3wModal").classList.remove("show");
$("#w3wGPS").onclick=()=>navigator.geolocation?.getCurrentPosition(
  pos=>{$("#w3wInput").value=`${pos.coords.latitude},${pos.coords.longitude}`; $("#w3wStatus").textContent="GPS captured";},
  ()=>$("#w3wStatus").textContent="GPS unavailable"
);
$("#w3wValidate").onclick=()=>{const s=$("#w3wInput").value||""; $("#w3wStatus").textContent=is3w(s)?"✓ three words":(isLL(s)?"✓ lat,long":"Unrecognised (stored raw)")};
$("#w3wSave").onclick=()=>{const s=($("#w3wInput").value||"").trim().replace(/^\/+/, ''); if(!s){$("#w3wStatus").textContent="Nothing entered";return}
  if(is3w(s)) state.w3w={words:s.toLowerCase()}; else if(isLL(s)){const [lat,lng]=s.split(',').map(x=>+x.trim()); state.w3w={coords:{lat,lng}};} else state.w3w={raw:s};
  save(); $("#w3wModal").classList.remove("show"); const v=document.querySelector(`[data-section="${W3W_SECTION}"] #w3wView`); if(v) v.textContent=state.w3w.words?`///${state.w3w.words}`:(state.w3w.coords?`${state.w3w.coords.lat},${state.w3w.coords.lng}`:(state.w3w.raw||"—"));
};

/* ---------- JSON ---------- */
function buildJSON(){
  const out={meta:{generatedAt:new Date().toISOString(),sourceURL:$("#url").value||DEFAULT_URL,what3words:state.w3w||null},sections:{}};
  UI.forEach(sec=>{
    if(sec==="Summary") return;
    const picks=listOf(state.selections[sec]).map(k=>{const i=k.indexOf("|"); return {code:i>-1?k.slice(0,i):"", text:i>-1?k.slice(i+1):k}});
    const human=[picks.length?("• "+picks.map(p=>(p.code?`${p.code} – `:"")+p.text).join("; ")):"", (state.custom?.[sec]||[]).map(x=>"• "+x).join(" "), state.notes?.[sec]||""].filter(Boolean).join(" ");
    out.sections[sec]={text:human.trim(),picks,custom:state.custom?.[sec]||[],notes:state.notes?.[sec]||""};
  });
  return out;
}
function downloadJSON(){
  const blob=new Blob([JSON.stringify(buildJSON(),null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`depot-notes_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click();
}

/* ---------- Controls ---------- */
$("#btnFetch").onclick=async()=>{
  try{const txt=await fetchWithFallback([$("#url").value||DEFAULT_URL, RAW_URL, GH_HTML]); applyOptionsText(txt);}
  catch(e){log(e.message,"bad"); buildUI();}
};
$("#file").onchange=async(e)=>{const f=e.target.files[0]; if(!f) return; const txt=await f.text(); $("#status").textContent=`Loaded local file: ${f.name}`; $("#status").className="status ok"; applyOptionsText(txt);};
$("#btnPaste").onclick=()=>{
  const t=prompt("Paste Options.txt content below:\n\n"); if(t){$("#status").textContent="Loaded from paste"; $("#status").className="status ok"; applyOptionsText(t);}
};
$("#btnReload").onclick=()=>buildUI();

/* ---------- Boot (safe) ---------- */
(function boot(){
  $("#url").value = $("#url").value || DEFAULT_URL;
  // Build UI immediately so it never looks empty
  state.map = state.map || {}; buildUI();
  // Try to prefetch async (won't block UI)
  fetchWithFallback([DEFAULT_URL, RAW_URL, GH_HTML]).then(applyOptionsText).catch(err=>{log("Prefetch failed (use Paste/File/Fetch): "+err.message,"bad")});
})();

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(err=>console.warn('SW registration failed',err));
  });
}
</script>
</body>
</html>
