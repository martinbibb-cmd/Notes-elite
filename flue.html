<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flue Route Builder (Top Exit)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f6fb;
      --card: #fff;
      --border: #dbe1ea;
      --accent: #0ea5e9;
    }
    body {
      margin: 0;
      font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
      background: var(--bg);
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 12px;
      box-sizing: border-box;
    }
    .sidebar h2 {
      font-size: 14px;
      margin: 0 0 8px;
    }
    .btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      text-align: left;
      font-size: 13px;
      cursor: pointer;
    }
    .btn:hover {
      border-color: var(--accent);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      padding: 10px 14px;
      background: #fff;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }
    .badge {
      background: #eff6ff;
      color: #0f3c79;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 6px;
    }
    .canvas-wrap {
      flex: 1;
      background: #edf0f6;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    svg {
      background: #edf0f6;
      border: 1px solid #ccd1da;
    }
    .panel {
      padding: 10px 14px;
      background: #fff;
      border-top: 1px solid var(--border);
      font-size: 12px;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      box-sizing: border-box;
      padding: 4px 6px;
      background: #f9fafb;
    }
    .vector-grid {
      display: grid;
      grid-template-columns: repeat(3, 30px);
      grid-gap: 4px;
    }
    .vector-grid button {
      background: #fff;
      border: 1px solid #dbe1ea;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      line-height: 1;
    }
    .vector-grid button:hover {
      border-color: #0ea5e9;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Flue Parts</h2>
    <button class="btn" data-action="straight" data-length="1000">‚ûï Straight 1m</button>
    <button class="btn" data-action="straight" data-length="500">‚ûï Straight 0.5m</button>
    <button class="btn" data-action="elbow" data-angle="45">‚Ü™ 45¬∞ bend</button>
    <button class="btn" data-action="elbow" data-angle="90">‚Ü™ 90¬∞ bend</button>
    <button class="btn" data-action="terminal-horiz">‚èπ Horizontal terminal</button>
    <button class="btn" data-action="plume-kit">üåÄ Plume kit</button>
    <button class="btn" data-action="vertical-rise">‚¨Ü Vertical rise (to roof)</button>
    <button class="btn" data-action="roof-pitched">üè† Roof terminal ‚Äì pitched</button>
    <button class="btn" data-action="roof-flat">üß± Roof terminal ‚Äì flat</button>
    <hr />
    <button class="btn" id="reset">üóë Clear route</button>
  </div>
  <div class="main">
    <div class="topbar">
      <div>
        <span class="badge" id="eq-length">Eq: 0.0m</span>
        <span class="badge" id="bends">Bends: 0</span>
        <span class="badge" id="status">OK</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-size:12px;color:#64748b">Vector</div>
        <div class="vector-grid">
          <button data-dir="315">‚ÜñÔ∏è</button>
          <button data-dir="270">‚¨ÜÔ∏è</button>
          <button data-dir="225">‚ÜóÔ∏è</button>
          <button data-dir="0">‚¨ÖÔ∏è</button>
          <button data-rotate="cw">üîÑ</button>
          <button data-dir="180">‚û°Ô∏è</button>
          <button data-dir="45">‚ÜôÔ∏è</button>
          <button data-dir="90">‚¨áÔ∏è</button>
          <button data-dir="135">‚ÜòÔ∏è</button>
        </div>
      </div>
    </div>
    <div class="canvas-wrap">
      <svg id="flue-svg" width="640" height="460" viewBox="0 0 640 460">
        <!-- wall -->
        <line x1="520" y1="0" x2="520" y2="460" stroke="#e11d48" stroke-dasharray="4 4" stroke-width="1.5"></line>
        <!-- boiler -->
        <rect x="80" y="210" width="60" height="90" rx="6" fill="#fff" stroke="#94a3b8"></rect>
        <text x="110" y="225" text-anchor="middle" font-size="10" fill="#0f172a">Boiler</text>
        <!-- top outlet -->
        <circle id="boiler-out" cx="110" cy="210" r="4" fill="#0ea5e9"></circle>
      </svg>
    </div>
    <div class="panel">
      <label for="json-out" style="display:block;margin-bottom:4px;">Route JSON:</label>
      <textarea id="json-out" readonly></textarea>
    </div>
  </div>

  <script>
    // CONFIG
    const EQ = {
      straightPerMm: 1 / 1000,
      bend45: 0.5,       // put proper Worcester/Vaillant values here later
      bend90: 1.0,
      plumeKit: 1.5,
      verticalRisePerMm: 1 / 1000,
      roofTerminal: 1.0
    };
    const MAX_EQ = 10;

    const svg = document.getElementById('flue-svg');
    const eqSpan = document.getElementById('eq-length');
    const bendsSpan = document.getElementById('bends');
    const statusSpan = document.getElementById('status');
    const jsonOut = document.getElementById('json-out');

    // Start at TOP of boiler, pointing UP
    let parts = [];
    let cursor = { x: 110, y: 210, angle: -90 }; // -90 = up

    function degToRad(d) { return d * Math.PI / 180; }

    function addStraight(mm) {
      const scale = 0.1;
      const rad = degToRad(cursor.angle);
      const x2 = cursor.x + Math.cos(rad) * (mm * scale);
      const y2 = cursor.y + Math.sin(rad) * (mm * scale);
      parts.push({
        type: 'straight',
        mm,
        x1: cursor.x,
        y1: cursor.y,
        x2,
        y2
      });
      cursor.x = x2;
      cursor.y = y2;
    }

    function addElbow(deltaAngle) {
      parts.push({
        type: 'elbow',
        angle: deltaAngle,
        x: cursor.x,
        y: cursor.y
      });
      cursor.angle = (cursor.angle + deltaAngle) % 360;
    }

    function addHorizontalTerminal() {
      parts.push({
        type: 'terminal-horizontal',
        x: cursor.x,
        y: cursor.y
      });
    }

    function addPlumeKit() {
      const scale = 0.1;
      const upMm = 400;
      const x1 = cursor.x;
      const y1 = cursor.y;
      const y2 = y1 - (upMm * scale);
      parts.push({
        type: 'plume-kit',
        x1,
        y1,
        x2: x1,
        y2,
        headDir: 0
      });
      cursor.x = x1;
      cursor.y = y2;
      cursor.angle = 0; // blow out to right
    }

    function addVerticalRise(mm = 1000) {
      const scale = 0.1;
      const x1 = cursor.x;
      const y1 = cursor.y;
      const y2 = y1 - (mm * scale);
      parts.push({
        type: 'vertical-rise',
        mm,
        x1,
        y1,
        x2: x1,
        y2
      });
      cursor.x = x1;
      cursor.y = y2;
      cursor.angle = -90;
    }

    function addRoofTerminal(kind) {
      parts.push({
        type: 'roof-terminal',
        variant: kind,
        x: cursor.x,
        y: cursor.y
      });
    }

    function rebuildSVG() {
      [...svg.querySelectorAll('.route-part')].forEach(el => el.remove());

      parts.forEach(p => {
        if (p.type === 'straight' || p.type === 'vertical-rise') {
          // draw thick tube
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', p.x1);
          line.setAttribute('y1', p.y1);
          line.setAttribute('x2', p.x2);
          line.setAttribute('y2', p.y2);
          line.setAttribute('stroke', '#0f172a');
          line.setAttribute('stroke-width', '7');
          line.setAttribute('stroke-linecap', 'round');
          line.setAttribute('class', 'route-part');
          svg.appendChild(line);
        } else if (p.type === 'elbow') {
          // draw a small square/plate to show elbow
          const s = 12;
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', p.x - s/2);
          rect.setAttribute('y', p.y - s/2);
          rect.setAttribute('width', s);
          rect.setAttribute('height', s);
          rect.setAttribute('fill', '#fb7185');
          rect.setAttribute('rx', 3);
          rect.setAttribute('class', 'route-part');
          svg.appendChild(rect);
        } else if (p.type === 'terminal-horizontal') {
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', p.x);
          rect.setAttribute('y', p.y - 6);
          rect.setAttribute('width', 18);
          rect.setAttribute('height', 12);
          rect.setAttribute('fill', '#22c55e');
          rect.setAttribute('rx', 2);
          rect.setAttribute('class', 'route-part');
          svg.appendChild(rect);
        } else if (p.type === 'plume-kit') {
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', p.x1);
          line.setAttribute('y1', p.y1);
          line.setAttribute('x2', p.x2);
          line.setAttribute('y2', p.y2);
          line.setAttribute('stroke', '#6366f1');
          line.setAttribute('stroke-width', '6');
          line.setAttribute('stroke-linecap', 'round');
          line.setAttribute('class', 'route-part');
          svg.appendChild(line);

          const head = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          head.setAttribute('x', p.x2);
          head.setAttribute('y', p.y2 - 5);
          head.setAttribute('width', 18);
          head.setAttribute('height', 10);
          head.setAttribute('fill', '#6366f1');
          head.setAttribute('class', 'route-part');
          svg.appendChild(head);
        } else if (p.type === 'roof-terminal') {
          const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          if (p.variant === 'pitched') {
            const d = `${p.x},${p.y} ${p.x+16},${p.y} ${p.x+8},${p.y-10}`;
            poly.setAttribute('points', d);
          } else {
            const d = `${p.x},${p.y} ${p.x+16},${p.y} ${p.x+16},${p.y-6} ${p.x},${p.y-6}`;
            poly.setAttribute('points', d);
          }
          poly.setAttribute('fill', '#f97316');
          poly.setAttribute('class', 'route-part');
          svg.appendChild(poly);
        }
      });

      updateStats();
    }

    function updateStats() {
      let eq = 0;
      let bends = 0;
      parts.forEach(p => {
        if (p.type === 'straight') {
          eq += (p.mm * EQ.straightPerMm);
        } else if (p.type === 'vertical-rise') {
          eq += (p.mm * EQ.verticalRisePerMm);
        } else if (p.type === 'elbow') {
          bends++;
          eq += (Math.abs(p.angle) === 90 ? EQ.bend90 : EQ.bend45);
        } else if (p.type === 'plume-kit') {
          eq += EQ.plumeKit;
        } else if (p.type === 'roof-terminal') {
          eq += EQ.roofTerminal;
        }
      });
      eqSpan.textContent = `Eq: ${eq.toFixed(1)}m`;
      bendsSpan.textContent = `Bends: ${bends}`;
      if (eq > MAX_EQ) {
        statusSpan.textContent = `Over max (${MAX_EQ}m)`;
        statusSpan.style.background = '#fee2e2';
        statusSpan.style.color = '#b91c1c';
      } else {
        statusSpan.textContent = `OK`;
        statusSpan.style.background = '#eff6ff';
        statusSpan.style.color = '#0f3c79';
      }

      jsonOut.value = JSON.stringify({
        start: { x: 110, y: 210, exit: "top" },
        parts: parts
      }, null, 2);
    }

    // part buttons
    document.querySelectorAll('.btn[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.dataset.action;
        if (act === 'straight') addStraight(Number(btn.dataset.length));
        else if (act === 'elbow') addElbow(Number(btn.dataset.angle));
        else if (act === 'terminal-horiz') addHorizontalTerminal();
        else if (act === 'plume-kit') addPlumeKit();
        else if (act === 'vertical-rise') addVerticalRise(1000);
        else if (act === 'roof-pitched') addRoofTerminal('pitched');
        else if (act === 'roof-flat') addRoofTerminal('flat');
        rebuildSVG();
      });
    });

    // vector controls
    document.querySelectorAll('.vector-grid button').forEach(btn => {
      btn.addEventListener('click', () => {
        const dir = btn.dataset.dir;
        const rot = btn.dataset.rotate;
        if (dir !== undefined) {
          cursor.angle = Number(dir); // set absolute heading
        } else if (rot === 'cw') {
          cursor.angle = (cursor.angle + 90) % 360;
        }
      });
    });

    document.getElementById('reset').addEventListener('click', () => {
      parts = [];
      cursor = { x: 110, y: 210, angle: -90 };
      rebuildSVG();
    });

    rebuildSVG();
  </script>
</body>
</html>
