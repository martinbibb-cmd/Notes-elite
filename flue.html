<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flue Route Builder (guided)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f6fb;
      --card: #fff;
      --border: #dbe1ea;
      --accent: #0ea5e9;
    }
    body {
      margin: 0;
      font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
      background: var(--bg);
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid var(--border);
      padding: 12px;
      box-sizing: border-box;
    }
    .sidebar h2 {
      font-size: 14px;
      margin: 0 0 8px;
    }
    .btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      text-align: left;
      font-size: 13px;
      cursor: pointer;
    }
    .btn:hover {
      border-color: var(--accent);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .topbar {
      padding: 10px 14px;
      background: #fff;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }
    .badge {
      background: #eff6ff;
      color: #0f3c79;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 6px;
    }
    .canvas-wrap {
      flex: 1;
      background: #edf0f6;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    svg {
      background: #edf0f6;
      border: 1px solid #ccd1da;
    }
    .panel {
      padding: 10px 14px;
      background: #fff;
      border-top: 1px solid var(--border);
      font-size: 12px;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      box-sizing: border-box;
      padding: 4px 6px;
      background: #f9fafb;
    }
    .vector-grid {
      display: grid;
      grid-template-columns: repeat(3, 30px);
      grid-gap: 4px;
    }
    .vector-grid button {
      background: #fff;
      border: 1px solid #dbe1ea;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      line-height: 1;
    }
    .vector-grid button:hover {
      border-color: #0ea5e9;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Manual parts</h2>
    <button class="btn" data-action="straight" data-length="1000">â• Straight 1m</button>
    <button class="btn" data-action="straight" data-length="500">â• Straight 0.5m</button>
    <button class="btn" data-action="elbow" data-angle="45">â†ª 45Â° bend</button>
    <button class="btn" data-action="elbow" data-angle="90">â†ª 90Â° bend</button>
    <hr />
    <h2>Penetrations</h2>
    <button class="btn" data-action="penetrate-wall">ğŸ§± Penetrate wall</button>
    <button class="btn" data-action="penetrate-roof-pitched">ğŸ  Penetrate roof (pitched)</button>
    <button class="btn" data-action="penetrate-roof-flat">ğŸ§± Penetrate roof (flat)</button>
    <button class="btn" data-action="terminate">â¹ Terminate here</button>
    <button class="btn" data-action="plume-kit">ğŸŒ€ Plume kit (after penetration)</button>
    <hr />
    <button class="btn" id="reset">ğŸ—‘ Clear route</button>
  </div>
  <div class="main">
    <div class="topbar">
      <div>
        <span class="badge" id="eq-length">Eq: 0.0m</span>
        <span class="badge" id="bends">Bends: 0</span>
        <span class="badge" id="status">OK</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-size:12px;color:#64748b">Tap to auto-add elbow/length</div>
        <div class="vector-grid">
          <button data-dir="315">â†–ï¸</button>
          <button data-dir="270">â¬†ï¸</button>
          <button data-dir="225">â†—ï¸</button>
          <button data-dir="0">â¬…ï¸</button>
          <button data-rotate="cw">ğŸ”„</button>
          <button data-dir="180">â¡ï¸</button>
          <button data-dir="45">â†™ï¸</button>
          <button data-dir="90">â¬‡ï¸</button>
          <button data-dir="135">â†˜ï¸</button>
        </div>
      </div>
    </div>
    <div class="canvas-wrap">
      <svg id="flue-svg" width="640" height="460" viewBox="0 0 640 460">
        <!-- wall line -->
        <line x1="520" y1="0" x2="520" y2="460" stroke="#e11d48" stroke-dasharray="4 4" stroke-width="1.5"></line>
        <!-- boiler -->
        <rect x="80" y="210" width="60" height="90" rx="6" fill="#fff" stroke="#94a3b8"></rect>
        <text x="110" y="225" text-anchor="middle" font-size="10" fill="#0f172a">Boiler</text>
        <!-- top outlet -->
        <circle id="boiler-out" cx="110" cy="210" r="4" fill="#0ea5e9"></circle>
      </svg>
    </div>
    <div class="panel">
      <label for="json-out" style="display:block;margin-bottom:4px;">Route JSON (for Notes-Elite):</label>
      <textarea id="json-out" readonly></textarea>
    </div>
  </div>

  <script>
    // Basic equivalent length config â€” we can brand-split later
    const EQ = {
      straightPerMm: 1 / 1000,
      bend45: 0.5,
      bend90: 1.0,
      plumeKit: 1.5,
      penetration: 0.5
    };
    const MAX_EQ = 10;

    const svg = document.getElementById('flue-svg');
    const eqSpan = document.getElementById('eq-length');
    const bendsSpan = document.getElementById('bends');
    const statusSpan = document.getElementById('status');
    const jsonOut = document.getElementById('json-out');

    // state
    let parts = [];
    let cursor = { x: 110, y: 210, angle: -90 }; // top exit, pointing up
    let lastWasPenetration = false; // for plume rule

    function degToRad(d) { return d * Math.PI / 180; }

    function addStraight(mm) {
      const scale = 0.1;
      const rad = degToRad(cursor.angle);
      const x2 = cursor.x + Math.cos(rad) * (mm * scale);
      const y2 = cursor.y + Math.sin(rad) * (mm * scale);
      parts.push({
        type: 'straight',
        mm,
        x1: cursor.x,
        y1: cursor.y,
        x2,
        y2
      });
      cursor.x = x2;
      cursor.y = y2;
      lastWasPenetration = false;
    }

    function addElbowTo(angleTarget) {
      // angleTarget is absolute
      const current = cursor.angle;
      let delta = angleTarget - current;
      // normalise to -180..180
      delta = ((delta + 180) % 360) - 180;
      parts.push({
        type: 'elbow',
        angle: delta,
        x: cursor.x,
        y: cursor.y
      });
      cursor.angle = angleTarget;
      lastWasPenetration = false;
    }

    function addHorizontalTerminal() {
      parts.push({
        type: 'terminal',
        x: cursor.x,
        y: cursor.y
      });
      lastWasPenetration = false;
    }

    function addPenetration(kind) {
      parts.push({
        type: 'penetration',
        variant: kind,
        x: cursor.x,
        y: cursor.y
      });
      lastWasPenetration = true;
    }

    function addPlumeKit() {
      if (!lastWasPenetration) {
        alert("Plume kit can only be added immediately after a penetration.");
        return;
      }
      // simple plume head
      const head = {
        type: 'plume-kit',
        x: cursor.x,
        y: cursor.y - 10
      };
      parts.push(head);
      lastWasPenetration = false; // done
    }

    function rebuildSVG() {
      [...svg.querySelectorAll('.route-part')].forEach(el => el.remove());

      parts.forEach(p => {
        if (p.type === 'straight') {
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', p.x1);
          line.setAttribute('y1', p.y1);
          line.setAttribute('x2', p.x2);
          line.setAttribute('y2', p.y2);
          line.setAttribute('stroke', '#0f172a');
          line.setAttribute('stroke-width', '7');
          line.setAttribute('stroke-linecap', 'round');
          line.setAttribute('class', 'route-part');
          svg.appendChild(line);
        } else if (p.type === 'elbow') {
          const s = 14;
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', p.x - s/2);
          rect.setAttribute('y', p.y - s/2);
          rect.setAttribute('width', s);
          rect.setAttribute('height', s);
          rect.setAttribute('fill', '#fb7185');
          rect.setAttribute('rx', 3);
          rect.setAttribute('class', 'route-part');
          svg.appendChild(rect);
        } else if (p.type === 'penetration') {
          const circ = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circ.setAttribute('cx', p.x);
          circ.setAttribute('cy', p.y);
          circ.setAttribute('r', 6);
          circ.setAttribute('fill', p.variant.includes('wall') ? '#f97316' : '#facc15');
          circ.setAttribute('class', 'route-part');
          svg.appendChild(circ);
        } else if (p.type === 'plume-kit') {
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', p.x);
          rect.setAttribute('y', p.y - 5);
          rect.setAttribute('width', 18);
          rect.setAttribute('height', 10);
          rect.setAttribute('fill', '#6366f1');
          rect.setAttribute('rx', 2);
          rect.setAttribute('class', 'route-part');
          svg.appendChild(rect);
        } else if (p.type === 'terminal') {
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', p.x);
          rect.setAttribute('y', p.y - 6);
          rect.setAttribute('width', 16);
          rect.setAttribute('height', 12);
          rect.setAttribute('fill', '#22c55e');
          rect.setAttribute('rx', 2);
          rect.setAttribute('class', 'route-part');
          svg.appendChild(rect);
        }
      });

      updateStats();
    }

    function updateStats() {
      let eq = 0;
      let bends = 0;
      parts.forEach(p => {
        if (p.type === 'straight') {
          eq += p.mm * EQ.straightPerMm;
        } else if (p.type === 'elbow') {
          bends++;
          eq += (Math.abs(p.angle) === 90 ? EQ.bend90 : EQ.bend45);
        } else if (p.type === 'penetration') {
          eq += EQ.penetration;
        } else if (p.type === 'plume-kit') {
          eq += EQ.plumeKit;
        }
      });
      eqSpan.textContent = `Eq: ${eq.toFixed(1)}m`;
      bendsSpan.textContent = `Bends: ${bends}`;
      if (eq > MAX_EQ) {
        statusSpan.textContent = `Over max (${MAX_EQ}m)`;
        statusSpan.style.background = '#fee2e2';
        statusSpan.style.color = '#b91c1c';
      } else {
        statusSpan.textContent = `OK`;
        statusSpan.style.background = '#eff6ff';
        statusSpan.style.color = '#0f3c79';
      }

      jsonOut.value = JSON.stringify({
        start: { x: 110, y: 210, exit: "top" },
        parts: parts
      }, null, 2);
    }

    // manual buttons
    document.querySelectorAll('.btn[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.dataset.action;
        if (act === 'straight') addStraight(Number(btn.dataset.length));
        else if (act === 'elbow') addElbowTo((cursor.angle + Number(btn.dataset.angle)) % 360);
        else if (act === 'penetrate-wall') addPenetration('wall');
        else if (act === 'penetrate-roof-pitched') addPenetration('roof-pitched');
        else if (act === 'penetrate-roof-flat') addPenetration('roof-flat');
        else if (act === 'terminate') addHorizontalTerminal();
        else if (act === 'plume-kit') addPlumeKit();
        rebuildSVG();
      });
    });

    // vector smart add: if direction != current â†’ elbow, else â†’ straight
    document.querySelectorAll('.vector-grid button').forEach(btn => {
      btn.addEventListener('click', () => {
        const dir = btn.dataset.dir;
        const rot = btn.dataset.rotate;
        if (dir !== undefined) {
          const target = Number(dir);
          const current = cursor.angle;
          // normalised equality check
          const diff = Math.abs((((target - current) % 360) + 360) % 360);
          if (diff > 1) {
            // add elbow to that direction
            addElbowTo(target);
          } else {
            // already in that direction, add straight
            addStraight(1000);
          }
          rebuildSVG();
        } else if (rot === 'cw') {
          const newDir = (cursor.angle + 90) % 360;
          addElbowTo(newDir);
          rebuildSVG();
        }
      });
    });

    document.getElementById('reset').addEventListener('click', () => {
      parts = [];
      cursor = { x: 110, y: 210, angle: -90 };
      lastWasPenetration = false;
      rebuildSVG();
    });

    // initial draw
    rebuildSVG();
  </script>
</body>
</html>
